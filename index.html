<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced Chat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Login Screen */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-btn {
            background: #4285F4; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Chat UI */
        #chatInterface { display: none; flex-direction: column; height: 100%; }

        /* Header */
        .header { background: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
        .edit-hint { font-size: 10px; color: #0084ff; display: block; }
        .logout-btn { background: #ff4d4f; color: white; border: none; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; }

        /* Chat Area */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: url('https://i.ibb.co/3s1f9Jq/default-wallpaper.png'); background-size: cover; }
        
        .message-row { display: flex; width: 100%; align-items: flex-end; gap: 8px; }
        .my-row { flex-direction: row-reverse; }
        
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: #ccc; flex-shrink: 0; object-fit: cover; }
        
        .bubble-container { display: flex; flex-direction: column; max-width: 75%; }
        
        .bubble { padding: 8px 12px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;}
        .my-bubble { background: #dcf8c6; color: black; border-bottom-right-radius: 0; }
        .other-bubble { background: white; color: black; border-bottom-left-radius: 0; }
        
        .bubble img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        /* Status Ticks (Sent/Seen) */
        .msg-info { display: flex; justify-content: flex-end; align-items: center; gap: 3px; margin-top: 2px; }
        .time { font-size: 10px; color: #999; }
        .ticks { font-size: 10px; font-weight: bold; display: none; } /* Only show for my messages */
        .my-row .ticks { display: inline; }
        .tick-sent { color: #999; } /* Grey Tick */
        .tick-seen { color: #34b7f1; } /* Blue Tick */

        /* Input Bar */
        .input-bar { background: white; padding: 8px 10px; display: flex; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .icon-btn { font-size: 22px; padding: 0 10px; cursor: pointer; }
        .msg-input { flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px 15px; border-radius: 25px; outline: none; font-size: 15px; }
        .send-btn { background: #0084ff; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; margin-left: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Edit Profile Modal */
        #editModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 80%; text-align: center; }
        .modal-btn { padding: 10px 20px; margin-top: 10px; border-radius: 5px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h2 style="color:#333; margin-bottom: 20px;">Chat App</h2>
        <button class="login-btn" onclick="googleLogin()"><span>G</span> Login with Google</button>
    </div>

    <div id="chatInterface">
        <div class="header">
            <div class="user-profile" onclick="openEditModal()">
                <img id="myDisplayPic" src="" alt="Profile">
                <div>
                    <span id="myName" style="font-weight:600; font-size:14px; display:block;">User</span>
                    <span class="edit-hint">·Äï·ÄØ·Ä∂·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äî·Ä∫ ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</span>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="chat-area" id="messageList"></div>

        <div class="input-bar">
            <label for="imgUpload" class="icon-btn">üì∑</label>
            <input type="file" id="imgUpload" accept="image/*" style="display: none;">
            <input type="text" class="msg-input" id="msgInput" placeholder="·ÄÖ·Ä¨·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´..." autocomplete="off">
            <button class="send-btn" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="editModal">
        <div class="modal-content">
            <h3>Change Profile Picture</h3>
            <input type="file" id="profileUpload" accept="image/*" style="margin: 15px 0;">
            <br>
            <button class="modal-btn" style="background:#0084ff; color:white;" onclick="saveProfilePic()">Save</button>
            <button class="modal-btn" style="background:#ddd;" onclick="closeEditModal()">Cancel</button>
        </div>
    </div>

<script>
    // --------------------------------------------------------------
    // ‚ö†Ô∏è ·Äû·ÄÑ·Ä∑·Ä∫ Firebase Config ·ÄÄ·Ä≠·ÄØ ·Äí·ÄÆ·Äô·Äæ·Ä¨ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´
    // --------------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
  authDomain: "chat-27f21.firebaseapp.com",
  projectId: "chat-27f21",
  storageBucket: "chat-27f21.firebasestorage.app",
  messagingSenderId: "582814616396",
  appId: "1:582814616396:web:251660e2a50635bc70dde9"
};
    // --------------------------------------------------------------

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let myCurrentAvatar = ""; // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠·Äû·ÄØ·Ä∂·Ä∏·Äî·Ä±·Äê·Ä≤·Ä∑·Äï·ÄØ·Ä∂

    // --- Authentication ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'flex';
            
            // Database ·Äë·Ä≤·ÄÄ ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫ Profile ·Äï·ÄØ·Ä∂·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äô·Äö·Ä∫
            db.collection('users').doc(user.uid).get().then((doc) => {
                if(doc.exists && doc.data().photo) {
                    myCurrentAvatar = doc.data().photo;
                } else {
                    myCurrentAvatar = user.photoURL; // ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ Google ·Äï·ÄØ·Ä∂·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∫
                }
                updateHeaderUI();
            });

            loadMessages();
            markMessagesAsSeen(); // ·Äù·ÄÑ·Ä∫·Äú·Ä¨·Äê·Ä¨·Äî·Ä≤·Ä∑ ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·ÄÖ·Ä¨·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ Seen ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('chatInterface').style.display = 'none';
        }
    });

    function googleLogin() {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(alert);
    }
    function logout() { auth.signOut(); }

    function updateHeaderUI() {
        document.getElementById('myDisplayPic').src = myCurrentAvatar;
        document.getElementById('myName').innerText = currentUser.displayName;
    }

    // --- Profile Editing (Upload & Save) ---
    function openEditModal() { document.getElementById('editModal').style.flex = 'flex'; document.getElementById('editModal').style.display = 'flex'; }
    function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

    function saveProfilePic() {
        const file = document.getElementById('profileUpload').files[0];
        if (!file) return alert("·Äï·ÄØ·Ä∂·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´");
        
        // 1MB Limit ·ÄÖ·ÄÖ·Ä∫·Äô·Äö·Ä∫ (Database ·Äô·Äú·Ä±·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫)
        if (file.size > 1000000) return alert("·Äï·ÄØ·Ä∂·ÄÜ·Ä≠·ÄØ·Äí·Ä∫ ·ÄÄ·Äº·ÄÆ·Ä∏·Äú·ÄΩ·Äî·Ä∫·Ä∏·Äï·Ä´·Äê·Äö·Ä∫·Åã 1MB ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·ÄØ·Ä∂·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´·Åã");

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Img = e.target.result;
            // Database ·Äô·Äæ·Ä¨ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Äö·Ä∫ ('users' collection ·Äû·ÄÆ·Ä∏·Äû·Äî·Ä∑·Ä∫·ÄÜ·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏)
            db.collection('users').doc(currentUser.uid).set({
                photo: base64Img
            }, { merge: true }).then(() => {
                myCurrentAvatar = base64Img;
                updateHeaderUI();
                closeEditModal();
                alert("Profile ·Äï·ÄØ·Ä∂ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äú·Ä≤·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ!");
            });
        }
        reader.readAsDataURL(file);
    }

    // --- Chat Logic & Read Receipts ---

    function loadMessages() {
        db.collection("chats").orderBy("timestamp", "asc").onSnapshot((snapshot) => {
            const list = document.getElementById("messageList");
            list.innerHTML = ""; 

            snapshot.forEach((doc) => {
                const data = doc.data();
                const isMe = (currentUser && data.uid === currentUser.uid);

                const row = document.createElement("div");
                row.className = `message-row ${isMe ? "my-row" : "other-row"}`;

                // ·Äê·ÄÖ·Ä∫·Äñ·ÄÄ·Ä∫·Äú·Ä∞·Äï·ÄØ·Ä∂ (Data ·Äë·Ä≤·ÄÄ·Äï·ÄØ·Ä∂·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∫·Åä ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ ·Ä°·Äú·ÄΩ·Äê·Ä∫)
                let avatarHtml = isMe ? "" : `<img src="${data.photo || 'https://via.placeholder.com/30'}" class="avatar">`;

                // Status Ticks (Sent vs Seen)
                // status ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ 'sent' ·Äú·Ä≠·ÄØ·Ä∑ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫
                const status = data.status || 'sent';
                const tickHtml = (status === 'seen') 
                    ? `<span class="ticks tick-seen">‚úì‚úì</span>` // Seen (Blue)
                    : `<span class="ticks tick-sent">‚úì</span>`;  // Sent (Grey)

                let content = "";
                if (data.image) content += `<img src="${data.image}">`;
                if (data.text) content += `<div>${data.text}</div>`;

                // Time Format
                const date = data.timestamp ? data.timestamp.toDate() : new Date();
                const timeStr = date.getHours() + ":" + (date.getMinutes()<10?'0':'') + date.getMinutes();

                row.innerHTML = `
                    ${avatarHtml}
                    <div class="bubble-container">
                        <div class="bubble ${isMe ? "my-bubble" : "other-bubble"}">${content}</div>
                        <div class="msg-info">
                            <span class="time">${timeStr}</span>
                            ${tickHtml}
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
            list.scrollTop = list.scrollHeight;
        });
    }

    // ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·ÄÖ·Ä¨·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ 'seen' ·Äú·Ä≠·ÄØ·Ä∑ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äï·Ä±·Ä∏·Äê·Ä≤·Ä∑ Function
    function markMessagesAsSeen() {
        // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äô·Äü·ÄØ·Äê·Ä∫·Äê·Ä≤·Ä∑·ÄÖ·Ä¨·Äê·ÄΩ·Ä±·Åä status ·ÄÄ 'sent' ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äê·Ä¨·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·Ä¨·Äô·Äö·Ä∫
        db.collection("chats")
          .where("uid", "!=", currentUser.uid)
          .where("status", "==", "sent")
          .onSnapshot(snapshot => {
              snapshot.forEach(doc => {
                  // ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·ÄÖ·ÄÆ·ÄÄ·Ä≠·ÄØ 'seen' ·Äú·Ä≠·ÄØ·Ä∑ update ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
                  doc.ref.update({ status: 'seen' });
              });
          });
    }

    function sendMsg() {
        const input = document.getElementById("msgInput");
        const fileInput = document.getElementById("imgUpload");
        const text = input.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) return;

        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => saveToDB(text, e.target.result);
            reader.readAsDataURL(file);
        } else {
            saveToDB(text, null);
        }

        input.value = "";
        fileInput.value = "";
        input.focus();
    }

    function saveToDB(text, img) {
        db.collection("chats").add({
            text: text,
            image: img,
            uid: currentUser.uid,
            name: currentUser.displayName,
            photo: myCurrentAvatar, // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫·Äõ·Ä≤·Ä∑ Profile ·Äï·ÄØ·Ä∂·Ä°·Äû·ÄÖ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∫
            status: 'sent',         // ·Ä°·ÄÖ·Äô·Äæ·Ä¨ 'sent' ·Ä°·Äî·Ä±·Äî·Ä≤·Ä∑ ·Äï·Ä≠·ÄØ·Ä∑·Äô·Äö·Ä∫
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    document.getElementById("msgInput").addEventListener("keypress", (e) => {
        if(e.key === "Enter") sendMsg();
    });
</script>

</body>
</html>
