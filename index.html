<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Hub</title>
    
    <!-- Firebase SDK (v8.10.0) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #6C5DD3;
            --primary-soft: rgba(108, 93, 211, 0.1);
            --bg: #F0F2F5;
            --card: #FFFFFF;
            --text: #11142D;
            --gray: #808191;
            --border: #E4E4E4;
            --input: #F8F9FB;
        }

        [data-theme="dark"] {
            --bg: #18191A;
            --card: #242526;
            --text: #E4E6EB;
            --gray: #B0B3B8;
            --border: #3A3B3C;
            --input: #3A3B3C;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn { border: none; padding: 10px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .avatar { border-radius: 50%; object-fit: cover; background: #ddd; flex-shrink: 0; }

        /* --- PULL TO REFRESH --- */
        #ptr-spinner { 
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%); 
            z-index: 2000; display: none; 
            background: white; padding: 8px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .spinner-icon { width: 24px; height: 24px; border: 3px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- LOGIN --- */
        #loginScreen { position: fixed; inset: 0; background: var(--card); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-btn { width: 80%; max-width: 300px; padding: 12px; margin-bottom: 10px; background: var(--input); color: var(--text); border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; }

        /* --- APP STRUCTURE --- */
        #app { display: none; flex-direction: column; height: 100%; }
        
        .header { 
            height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border); z-index: 1000;
        }
        [data-theme="dark"] .header { background: rgba(36,37,38, 0.9); }

        .content { flex: 1; overflow-y: auto; padding-bottom: 80px; position: relative; }
        .tab { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- POSTS --- */
        .box { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .input-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .text-input { flex: 1; background: var(--input); border: none; padding: 10px 15px; border-radius: 20px; color: var(--text); }
        .img-preview { width: 100%; border-radius: 10px; display: none; margin-bottom: 10px; max-height: 200px; object-fit: cover; }
        
        .post-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .user-info { display: flex; gap: 10px; align-items: center; }
        .user-name { font-weight: 700; font-size: 15px; color: var(--text); }
        .post-time { font-size: 12px; color: var(--gray); }
        .post-body { font-size: 15px; line-height: 1.5; margin-bottom: 10px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 5px; }
        .post-actions { border-top: 1px solid var(--border); display: flex; padding-top: 10px; margin-top: 10px; }
        .act-btn { flex: 1; display: flex; justify-content: center; align-items: center; gap: 6px; color: var(--gray); font-weight: 600; cursor: pointer; }
        .liked { color: #FF754C; }

        /* --- CHAT OVERLAY --- */
        #chatScreen { position: fixed; inset: 0; background: var(--card); z-index: 3000; display: none; flex-direction: column; animation: slideIn 0.2s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .chat-head { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg); display: flex; flex-direction: column; gap: 8px; }
        
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 75%; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg-me { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-other { background: var(--card); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-meta { font-size: 10px; text-align: right; opacity: 0.7; margin-top: 2px; display: flex; align-items: center; justify-content: flex-end; gap: 3px;}

        /* --- NOTIFICATIONS --- */
        .notif-row { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card); border-radius: 12px; margin-bottom: 8px; }
        .unread-dot { width: 8px; height: 8px; background: #FF754C; border-radius: 50%; }

        /* --- NAV DOCK --- */
        .dock { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card); width: 90%; max-width: 400px; height: 65px;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 2000;
        }
        .dock-item { font-size: 26px; color: var(--gray); padding: 10px; border-radius: 12px; position: relative; transition: 0.2s; }
        .dock-item.active { color: var(--primary); transform: translateY(-5px); }
        .badge { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #FF754C; border-radius: 50%; display: none; }

    </style>
</head>
<body>

    <!-- Refresh Spinner -->
    <div id="ptr-spinner"><div class="spinner-icon"></div></div>

    <!-- Login -->
    <div id="loginScreen">
        <i class="ph-fill ph-planet" style="font-size: 60px; color: #6C5DD3; margin-bottom: 20px;"></i>
        <h2 style="margin: 0 0 30px 0; color: var(--text);">Social Hub</h2>
        <button class="login-btn" onclick="loginGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Google
        </button>
        <button class="login-btn" onclick="loginGithub()">
            <i class="ph-fill ph-github-logo" style="font-size:20px;"></i> GitHub
        </button>
    </div>

    <!-- Main App -->
    <div id="app">
        <div class="header">
            <b style="font-size: 20px; color: var(--primary);">Social</b>
            <div style="display:flex; gap:15px; align-items:center;">
                <i class="ph ph-moon" id="themeIcon" style="font-size:24px; cursor:pointer;" onclick="toggleTheme()"></i>
                <img id="myHeaderPic" class="avatar" style="width:36px; height:36px;" onclick="switchTab('profile')">
            </div>
        </div>

        <div class="content" id="scrollArea">
            
            <!-- HOME -->
            <div id="tab-home" class="tab active">
                <div class="box">
                    <div class="input-bar">
                        <img id="postAvatar" class="avatar" style="width:40px; height:40px;">
                        <input type="text" id="postText" class="text-input" placeholder="What's happening?">
                    </div>
                    <img id="previewImg" class="img-preview">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label for="postFile" style="color:var(--primary); font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                            <i class="ph ph-image"></i> Photo
                        </label>
                        <input type="file" id="postFile" accept="image/*" style="display:none" onchange="previewFile()">
                        <button class="btn btn-primary" onclick="submitPost()">Post</button>
                    </div>
                </div>
                <div id="feed"></div>
            </div>

            <!-- NOTIFICATIONS -->
            <div id="tab-notif" class="tab">
                <h3>Notifications</h3>
                <div id="notifList"></div>
            </div>

            <!-- FRIENDS -->
            <div id="tab-friends" class="tab">
                <h3>Chats</h3>
                <div id="friendList"></div>
            </div>

            <!-- PROFILE -->
            <div id="tab-profile" class="tab">
                <div class="box" style="text-align:center; padding:30px;">
                    <div style="position:relative; display:inline-block;">
                        <img id="profileBig" class="avatar" style="width:100px; height:100px;">
                        <label for="newProfile" style="position:absolute; bottom:0; right:0; background:var(--primary); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; cursor:pointer;">
                            <i class="ph-fill ph-camera"></i>
                        </label>
                        <input type="file" id="newProfile" accept="image/*" style="display:none" onchange="uploadProfilePic()">
                    </div>
                    <h2 id="profileName" style="margin:10px 0;">User</h2>
                    <input type="text" id="editName" class="text-input" style="text-align:center; margin-bottom:10px;" placeholder="Name">
                    <button class="btn btn-primary" style="width:100%" onclick="saveName()">Save Name</button>
                    <br>
                    <button class="btn" style="width:100%; background:rgba(255, 77, 79, 0.1); color:#FF4D4F;" onclick="auth.signOut()">Logout</button>
                </div>
            </div>
        </div>

        <!-- DOCK -->
        <div class="dock">
            <div class="dock-item active" onclick="switchTab('home', this)"><i class="ph-fill ph-house"></i></div>
            <div class="dock-item" onclick="switchTab('friends', this)"><i class="ph-fill ph-chats-circle"></i></div>
            <div class="dock-item" onclick="switchTab('notif', this)">
                <i class="ph-fill ph-bell"></i>
                <div class="badge" id="notifBadge"></div>
            </div>
            <div class="dock-item" onclick="switchTab('profile', this)"><i class="ph-fill ph-user"></i></div>
        </div>
    </div>

    <!-- Chat Overlay -->
    <div id="chatScreen">
        <div class="chat-head">
            <i class="ph ph-arrow-left" style="font-size:24px; cursor:pointer;" onclick="closeChat()"></i>
            <img id="chatHeaderPic" class="avatar" style="width:36px; height:36px;">
            <div style="font-weight:700;" id="chatHeaderName">User</div>
        </div>
        <div class="chat-list" id="msgList"></div>
        <div style="padding:10px; background:var(--card); border-top:1px solid var(--border); display:flex; gap:10px;">
            <input type="text" id="msgInput" class="text-input" placeholder="Message...">
            <button class="btn btn-primary" onclick="sendMsg()"><i class="ph-fill ph-paper-plane-right"></i></button>
        </div>
    </div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
      authDomain: "chat-27f21.firebaseapp.com",
      projectId: "chat-27f21",
      storageBucket: "chat-27f21.firebasestorage.app",
      messagingSenderId: "582814616396",
      appId: "1:582814616396:web:251660e2a50635bc70dde9"
    };
    const ADMIN_EMAIL = "mmtintaungkhaing@gmail.com"; 

    // --- 2. INIT ---
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let myData = {};
    let activeChatId = null;
    let activePartnerUid = null;
    let unsubChat = null;
    let unsubPartner = null;

    // --- 3. UTILS (Sorting & Theme) ---
    // Critical Fix: Sort in JS to avoid Missing Index Error
    const sortTimeDesc = (a, b) => (b.time?.toMillis() || Date.now()) - (a.time?.toMillis() || Date.now());
    const sortTimeAsc = (a, b) => (a.time?.toMillis() || Date.now()) - (b.time?.toMillis() || Date.now());

    const toggleTheme = () => {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const icon = document.getElementById('themeIcon');
        if(current === 'dark') {
            body.removeAttribute('data-theme');
            icon.className = 'ph ph-moon';
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.className = 'ph-fill ph-sun';
        }
    }

    // --- 4. AUTH ---
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) { myData = doc.data(); }
                else {
                    myData = { name: user.displayName, photo: user.photoURL, uid: user.uid, email: user.email, isAdmin: user.email === ADMIN_EMAIL };
                    doc.ref.set(myData);
                }
                updateUI();
                listenNotifs();
            });
            loadFeed();
            loadFriends();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }
    });

    const loginGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    const loginGithub = () => auth.signInWithPopup(new firebase.auth.GithubAuthProvider()).catch(alert);
    const updateUI = () => {
        ['myHeaderPic', 'postAvatar', 'profileBig'].forEach(id => document.getElementById(id).src = myData.photo);
        document.getElementById('profileName').innerText = myData.name;
        document.getElementById('editName').value = myData.name;
    };

    // --- 5. PULL TO REFRESH (Robust) ---
    const scrollArea = document.getElementById('scrollArea');
    const spinner = document.getElementById('ptr-spinner');
    let startY = 0;

    scrollArea.addEventListener('touchstart', e => { startY = e.touches[0].clientY; });
    scrollArea.addEventListener('touchmove', e => {
        const y = e.touches[0].clientY;
        if(scrollArea.scrollTop === 0 && y > startY + 60) {
            spinner.style.display = 'block';
        }
    });
    scrollArea.addEventListener('touchend', () => {
        if(spinner.style.display === 'block') {
            // Reload Feed logic
            loadFeed();
            setTimeout(() => { spinner.style.display = 'none'; }, 1000);
        }
    });

    // --- 6. FEED (Client Side Sort) ---
    const loadFeed = () => {
        // Query without orderBy to prevent Index Error
        db.collection('posts').limit(50).onSnapshot(snap => {
            const posts = [];
            snap.forEach(d => posts.push({id: d.id, ...d.data()}));
            posts.sort(sortTimeDesc); // Sort manually

            const div = document.getElementById('feed');
            div.innerHTML = "";
            posts.forEach(p => {
                const isLiked = p.likes && p.likes.includes(currentUser.uid);
                const badge = p.isAdmin ? `<i class="ph-fill ph-seal-check" style="color:var(--primary)"></i>` : '';
                const del = (p.uid === currentUser.uid || myData.isAdmin) ? `<i class="ph ph-trash" onclick="delPost('${p.id}')" style="color:red; cursor:pointer;"></i>` : '';
                
                div.innerHTML += `
                    <div class="box">
                        <div class="post-head">
                            <div class="user-info" onclick="openChat('${p.uid}')">
                                <img src="${p.authorPhoto}" class="avatar" style="width:40px; height:40px;">
                                <div>
                                    <div class="user-name">${p.authorName} ${badge}</div>
                                    <div class="post-time">${p.time ? new Date(p.time.toDate()).toLocaleTimeString() : 'Just now'}</div>
                                </div>
                            </div>
                            ${del}
                        </div>
                        <div class="post-body">${p.text || ''}</div>
                        ${p.image ? `<img src="${p.image}" class="post-img">` : ''}
                        <div class="post-actions">
                            <div class="act-btn ${isLiked?'liked':''}" onclick="likePost('${p.id}', ${isLiked}, '${p.uid}')">
                                <i class="${isLiked?'ph-fill':'ph'} ph-heart" style="font-size:20px"></i> ${p.likes?p.likes.length:0}
                            </div>
                        </div>
                    </div>
                `;
            });
        });
    };

    const submitPost = async () => {
        const txt = document.getElementById('postText').value;
        const img = document.getElementById('previewImg').style.display === 'block' ? document.getElementById('previewImg').src : null;
        if(!txt && !img) return;
        
        await db.collection('posts').add({
            text: txt, image: img, uid: currentUser.uid, 
            authorName: myData.name, authorPhoto: myData.photo, isAdmin: myData.isAdmin,
            likes: [], time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('postText').value = "";
        document.getElementById('previewImg').style.display = 'none';
    };

    const previewFile = () => {
        const file = document.getElementById('postFile').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('previewImg').src = e.target.result; document.getElementById('previewImg').style.display = 'block'; }
            r.readAsDataURL(file);
        }
    };
    const delPost = (id) => confirm("Delete?") && db.collection('posts').doc(id).delete();
    const likePost = (id, loved, owner) => {
        const ref = db.collection('posts').doc(id);
        if(loved) ref.update({likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)});
        else {
            ref.update({likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
            if(owner !== currentUser.uid) sendNotif(owner, "liked your post");
        }
    };

    // --- 7. CHAT (Dynamic Profile & Sorting) ---
    window.openChat = (uid) => {
        if(uid === currentUser.uid) return;
        activePartnerUid = uid;
        const ids = [currentUser.uid, uid].sort();
        activeChatId = ids.join("_");

        const screen = document.getElementById('chatScreen');
        screen.style.display = 'flex';
        
        // Live Partner Info
        if(unsubPartner) unsubPartner();
        unsubPartner = db.collection('users').doc(uid).onSnapshot(doc => {
            if(doc.exists) {
                const u = doc.data();
                document.getElementById('chatHeaderName').innerText = u.name;
                document.getElementById('chatHeaderPic').src = u.photo;
            }
        });

        // Messages with Client Sort
        if(unsubChat) unsubChat();
        unsubChat = db.collection('messages').where('cid', '==', activeChatId).onSnapshot(snap => {
            const msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.sort(sortTimeAsc); // Manual Sort

            const list = document.getElementById('msgList');
            list.innerHTML = "";
            
            msgs.forEach(m => {
                const isMe = m.uid === currentUser.uid;
                let ticks = "";
                if(isMe) ticks = m.status === 'seen' ? `<i class="ph-fill ph-checks" style="color:#00e676"></i>` : `<i class="ph ph-check"></i>`;
                
                list.innerHTML += `
                    <div class="msg ${isMe?'msg-me':'msg-other'}">
                        ${m.text}
                        <div class="msg-meta">${ticks}</div>
                    </div>
                `;
            });
            list.scrollTop = list.scrollHeight;
        });
    };

    const sendMsg = () => {
        const txt = document.getElementById('msgInput').value;
        if(!txt) return;
        db.collection('messages').add({
            cid: activeChatId, text: txt, uid: currentUser.uid, status: 'sent',
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        sendNotif(activePartnerUid, "sent you a message");
        document.getElementById('msgInput').value = "";
    };
    const closeChat = () => {
        document.getElementById('chatScreen').style.display = 'none';
        if(unsubChat) unsubChat();
        if(unsubPartner) unsubPartner();
    };

    // --- 8. NOTIFICATIONS & FRIENDS ---
    const listenNotifs = () => {
        db.collection('notifications').where('to', '==', currentUser.uid).onSnapshot(snap => {
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            const notifs = [];
            snap.forEach(d => notifs.push(d.data()));
            notifs.sort(sortTimeDesc);

            list.innerHTML = "";
            let unread = 0;
            notifs.forEach(n => {
                if(!n.read) unread++;
                list.innerHTML += `
                    <div class="notif-row">
                        <img src="${n.fromPhoto}" class="avatar" style="width:40px; height:40px;">
                        <div><b>${n.fromName}</b> ${n.text}</div>
                        ${!n.read ? '<div class="unread-dot"></div>' : ''}
                    </div>
                `;
            });
            badge.style.display = unread > 0 ? 'block' : 'none';
        });
    };

    const sendNotif = (to, txt) => {
        db.collection('notifications').add({
            to: to, fromName: myData.name, fromPhoto: myData.photo, text: txt, read: false,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
    };

    const loadFriends = () => {
        db.collection('users').onSnapshot(snap => {
            const list = document.getElementById('friendList');
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== currentUser.uid) {
                    list.innerHTML += `
                        <div class="notif-row" style="cursor:pointer;" onclick="openChat('${u.uid}')">
                            <img src="${u.photo}" class="avatar" style="width:45px; height:45px;">
                            <div style="flex:1; font-weight:600;">${u.name}</div>
                            <i class="ph-fill ph-chat-circle-dots" style="color:var(--primary); font-size:24px;"></i>
                        </div>
                    `;
                }
            });
        });
    };

    // --- 9. PROFILE ---
    window.saveName = () => db.collection('users').doc(currentUser.uid).update({name: document.getElementById('editName').value}).then(()=>alert("Saved"));
    window.uploadProfilePic = () => {
        const file = document.getElementById('newProfile').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => db.collection('users').doc(currentUser.uid).update({photo: e.target.result});
            r.readAsDataURL(file);
        }
    };
    window.switchTab = (tab, el) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
        if(el) {
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }
    };

</script>
</body>
</html>


