<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Chat App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; margin: 0; padding-bottom: 60px; height: 100dvh; overflow: hidden; }

        /* --- Loading Overlay --- */
        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Login Screen --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-btn {
            background: #1877f2; color: white; border: none; padding: 12px 30px; 
            border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;
        }

        /* --- Main App Container --- */
        #appInterface { display: none; height: 100%; flex-direction: column; }

        /* Header */
        .header {
            background: white; padding: 10px 15px; flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { margin: 0; color: #1877f2; font-size: 22px; }

        /* Scrollable Content Area */
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 20px; }

        /* Tabs */
        .tab-content { display: none; }
        .active-tab { display: block; }

        /* --- Create Post --- */
        .create-post { background: white; padding: 15px; margin-bottom: 10px; }
        .cp-top { display: flex; gap: 10px; margin-bottom: 10px; }
        .cp-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ddd; }
        .cp-input { 
            flex: 1; border: none; background: #f0f2f5; border-radius: 20px; 
            padding: 10px 15px; outline: none; font-size: 15px; 
        }
        .cp-actions { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 10px; }
        .post-btn { background: #1877f2; color: white; border: none; padding: 6px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* --- Feed Posts --- */
        .post-card { background: white; margin-bottom: 10px; padding-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .pc-header { padding: 10px 15px; display: flex; align-items: center; gap: 10px; justify-content: space-between; }
        .pc-user { display: flex; align-items: center; gap: 10px; cursor: pointer; } /* Clickable */
        .pc-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .pc-info h4 { margin: 0; font-size: 15px; }
        .admin-badge { color: #1877f2; margin-left: 4px; } 
        .pc-info span { font-size: 12px; color: #65676b; }
        
        .delete-btn { color: #65676b; cursor: pointer; font-size: 18px; padding: 5px; }
        .delete-btn:hover { color: red; }

        .pc-content { padding: 0 15px 10px; font-size: 15px; }
        .pc-image { width: 100%; display: block; max-height: 400px; object-fit: cover; margin-top: 5px; }
        
        /* --- People List --- */
        .person-row {
            display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .person-row:active { background-color: #f0f2f5; }
        .person-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        .person-name { font-weight: bold; font-size: 16px; color: #050505; }
        .chat-icon { margin-left: auto; color: #1877f2; font-size: 24px; }

        /* --- Chat Overlay (Private Message) --- */
        #chatOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1500; display: none; flex-direction: column;
        }
        .chat-header {
            padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; background: white;
        }
        .back-btn { font-size: 24px; cursor: pointer; border: none; background: none; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #eef1f5; }
        
        .msg-bubble { padding: 8px 14px; border-radius: 18px; max-width: 75%; font-size: 15px; word-wrap: break-word; }
        .msg-me { background: #1877f2; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-other { background: white; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }

        .chat-input-bar { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }

        /* --- Profile --- */
        .profile-card { background: white; padding: 20px; text-align: center; margin-top: 20px; }
        .big-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        
        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; height: 55px;
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 100;
        }
        .nav-item { font-size: 24px; color: #65676b; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-label { font-size: 10px; margin-top: 2px; }
        .nav-active { color: #1877f2; }

    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner"></div></div>

    <div id="loginScreen">
        <h1 style="color:#1877f2; margin-bottom:20px;">My Social</h1>
        <button class="login-btn" onclick="googleLogin()">Login with Google</button>
    </div>

    <div id="appInterface">
        
        <div class="header">
            <h1>Social</h1>
            <img id="headerAvatar" src="" style="width:30px; height:30px; border-radius:50%;">
        </div>

        <div class="content-area">
            
            <div id="homeTab" class="tab-content active-tab">
                <div class="create-post">
                    <div class="cp-top">
                        <img id="postAvatar" class="cp-avatar" src="">
                        <input type="text" id="postInput" class="cp-input" placeholder="·Äò·Ä¨·Äê·ÄΩ·Ä± ·Äê·ÄΩ·Ä±·Ä∏·Äî·Ä±·Äú·Ä≤...">
                    </div>
                    <img id="previewImg" style="width:100%; border-radius:8px; display:none; margin-bottom:10px;">
                    <div class="cp-actions">
                        <label for="postImg" style="color:#45bd62; font-weight:bold; cursor:pointer;">üì∑ Photo</label>
                        <input type="file" id="postImg" accept="image/*" style="display:none" onchange="previewFile()">
                        <button class="post-btn" onclick="submitPost()">Post</button>
                    </div>
                </div>
                <div id="feedContainer"></div>
            </div>

            <div id="peopleTab" class="tab-content">
                <div id="peopleList" style="padding-bottom:20px;"></div>
            </div>

            <div id="profileTab" class="tab-content">
                <div class="profile-card">
                    <img id="profilePic" class="big-avatar" src="">
                    <h2 id="profileName">User Name</h2>
                    <br>
                    <label style="color:#1877f2; cursor:pointer; font-weight:bold;">
                        [ Change Photo ]
                        <input type="file" id="newProfileImg" accept="image/*" style="display:none;" onchange="uploadProfilePic()">
                    </label>
                    <br><br>
                    <button onclick="logout()" style="background:#ddd; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Logout</button>
                </div>
            </div>

        </div>

        <div class="bottom-nav">
            <div class="nav-item nav-active" onclick="switchTab('home')">
                <span>üè†</span><span class="nav-label">Home</span>
            </div>
            <div class="nav-item" onclick="switchTab('people')">
                <span>üë•</span><span class="nav-label">Friends</span>
            </div>
            <div class="nav-item" onclick="switchTab('profile')">
                <span>üë§</span><span class="nav-label">Profile</span>
            </div>
        </div>
    </div>

    <div id="chatOverlay">
        <div class="chat-header">
            <button class="back-btn" onclick="closeChat()">‚Üê</button>
            <img id="chatPartnerPic" src="" style="width:35px; height:35px; border-radius:50%;">
            <h3 id="chatPartnerName" style="margin:0; font-size:16px;">User</h3>
        </div>
        <div class="chat-messages" id="privateMsgList"></div>
        <div class="chat-input-bar">
            <input type="text" id="privateInput" class="chat-input" placeholder="·ÄÖ·Ä¨·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´...">
            <button onclick="sendPrivateMsg()" style="background:none; border:none; font-size:24px; color:#1877f2;">‚û§</button>
        </div>
    </div>

<script>
    // --------------------------------------------------------------
    // ‚ö†Ô∏è CONFIGURATION
    // --------------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
  authDomain: "chat-27f21.firebaseapp.com",
  projectId: "chat-27f21",
  storageBucket: "chat-27f21.firebasestorage.app",
  messagingSenderId: "582814616396",
  appId: "1:582814616396:web:251660e2a50635bc70dde9"
};
   
    const ADMIN_EMAIL = "mmtintaungkhaing@gmail.com"; 
    // --------------------------------------------------------------

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let myUserData = {};
    let currentChatPartner = null; // ·Äò·Äö·Ä∫·Äû·Ä∞·Äî·Ä≤·Ä∑ ·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äî·Ä±·Äú·Ä≤
    let activeConversationId = null; 

    // --- Loading ---
    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

    // --- Auth Logic ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appInterface').style.display = 'flex';
            
            const userRef = db.collection('users').doc(user.uid);
            userRef.onSnapshot((doc) => {
                if(doc.exists) {
                    myUserData = doc.data();
                } else {
                    myUserData = {
                        name: user.displayName,
                        photo: user.photoURL,
                        email: user.email,
                        uid: user.uid,
                        isAdmin: (user.email === ADMIN_EMAIL)
                    };
                    userRef.set(myUserData);
                }
                updateUI();
                loadPeople(); // Load Friends List
            });

            loadFeed();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appInterface').style.display = 'none';
        }
    });

    function googleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut(); }

    function updateUI() {
        document.getElementById('headerAvatar').src = myUserData.photo;
        document.getElementById('postAvatar').src = myUserData.photo;
        document.getElementById('profilePic').src = myUserData.photo;
        document.getElementById('profileName').innerText = myUserData.name;
    }

    // --- Tab Switching ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
        
        if(tabName === 'home') {
            document.getElementById('homeTab').style.display = 'block';
            document.querySelectorAll('.nav-item')[0].classList.add('nav-active');
        } else if (tabName === 'people') {
            document.getElementById('peopleTab').style.display = 'block';
            document.querySelectorAll('.nav-item')[1].classList.add('nav-active');
        } else {
            document.getElementById('profileTab').style.display = 'block';
            document.querySelectorAll('.nav-item')[2].classList.add('nav-active');
        }
    }

    // --- Feed Logic (Post & Delete) ---
    function previewFile() {
        const file = document.getElementById('postImg').files[0];
        const preview = document.getElementById('previewImg');
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; }
            reader.readAsDataURL(file);
        }
    }

    function submitPost() {
        const text = document.getElementById('postInput').value;
        const file = document.getElementById('postImg').files[0];
        if(!text && !file) return;

        showLoading(true);

        const savePost = (img) => {
            db.collection('posts').add({
                text: text, image: img,
                uid: currentUser.uid,
                authorName: myUserData.name,
                authorPhoto: myUserData.photo,
                isAdmin: myUserData.isAdmin || false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showLoading(false);
                document.getElementById('postInput').value = "";
                document.getElementById('postImg').value = "";
                document.getElementById('previewImg').style.display = 'none';
            });
        };

        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => savePost(e.target.result);
            reader.readAsDataURL(file);
        } else { savePost(null); }
    }

    // (·ÅÇ) Post ·Äñ·Äª·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ Function
    function deletePost(postId) {
        if(confirm("·Äí·ÄÆ Post ·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äæ·Ä¨ ·Äû·Ä±·ÄÅ·Äª·Ä¨·Äú·Ä¨·Ä∏?")) {
            db.collection('posts').doc(postId).delete().then(() => {
                // ·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·Äª·Ä±·Ä¨·ÄÄ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äï·Ä´·Äô·Äö·Ä∫
            });
        }
    }

    function loadFeed() {
        db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
            const container = document.getElementById('feedContainer');
            container.innerHTML = "";

            snapshot.forEach(doc => {
                const post = doc.data();
                const badge = post.isAdmin ? `<span class="admin-badge">‚úì</span>` : ``;
                
                // (·ÅÇ) ·Äñ·Äª·ÄÄ·Ä∫·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫ ·Äõ·Äæ·Ä≠·Äô·Äõ·Äæ·Ä≠ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äï·Ä≠·ÄØ·ÄÑ·Ä∫ Post ·Äú·Ä¨·Ä∏? Admin ·Äú·Ä¨·Ä∏?)
                let deleteBtn = "";
                if (currentUser.uid === post.uid || myUserData.isAdmin) {
                    deleteBtn = `<span class="delete-btn" onclick="deletePost('${doc.id}')">üóëÔ∏è</span>`;
                }

                const html = `
                    <div class="post-card">
                        <div class="pc-header">
                            <div class="pc-user" onclick="openChat('${post.uid}', '${post.authorName}', '${post.authorPhoto}')">
                                <img src="${post.authorPhoto}" class="pc-avatar">
                                <div class="pc-info">
                                    <h4>${post.authorName} ${badge}</h4>
                                    <span>${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleTimeString() : ''}</span>
                                </div>
                            </div>
                            ${deleteBtn}
                        </div>
                        <div class="pc-content">
                            <p>${post.text || ''}</p>
                            ${post.image ? `<img src="${post.image}" class="pc-image">` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        });
    }

    // --- (·ÅÅ) Friends List Logic ---
    function loadPeople() {
        // App ·Äû·ÄØ·Ä∂·Ä∏·Äñ·Ä∞·Ä∏·Äû·Äô·Äª·Äæ ·Äú·Ä∞·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·ÄÜ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·Äï·Äº·Äô·Äö·Ä∫
        db.collection('users').onSnapshot(snapshot => {
            const list = document.getElementById('peopleList');
            list.innerHTML = "";
            
            snapshot.forEach(doc => {
                const user = doc.data();
                if(user.uid === currentUser.uid) return; // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·ÄÄ·Ä≠·ÄØ ·Äô·Äï·Äº·Äò·Ä∞·Ä∏

                const html = `
                    <div class="person-row" onclick="openChat('${user.uid}', '${user.name}', '${user.photo}')">
                        <img src="${user.photo}" class="person-avatar">
                        <span class="person-name">${user.name}</span>
                        <span class="chat-icon">üí¨</span>
                    </div>
                `;
                list.innerHTML += html;
            });
        });
    }

    // --- (·ÅÉ) Chat Logic (Private) ---
    function openChat(targetUid, name, photo) {
        currentChatPartner = { uid: targetUid, name: name, photo: photo };
        
        // Chat ID ·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (UID ·Äî·Äæ·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÄ·Ä≠·ÄØ ·ÄÖ·ÄÆ·Äï·Äº·ÄÆ·Ä∏ ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫ -> unique id ·Äõ·Äô·Äö·Ä∫)
        const ids = [currentUser.uid, targetUid].sort();
        activeConversationId = ids.join("_");

        // UI ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        document.getElementById('chatPartnerName').innerText = name;
        document.getElementById('chatPartnerPic').src = photo;
        document.getElementById('chatOverlay').style.display = 'flex';
        
        loadPrivateMessages();
    }

    function closeChat() {
        document.getElementById('chatOverlay').style.display = 'none';
        activeConversationId = null;
    }

    function loadPrivateMessages() {
        if(!activeConversationId) return;

        db.collection('direct_messages')
          .where('conversationId', '==', activeConversationId)
          .orderBy('timestamp', 'asc')
          .onSnapshot(snapshot => {
              const list = document.getElementById('privateMsgList');
              list.innerHTML = "";
              
              snapshot.forEach(doc => {
                  const data = doc.data();
                  const isMe = data.senderId === currentUser.uid;
                  
                  const html = `<div class="msg-bubble ${isMe ? 'msg-me' : 'msg-other'}">${data.text}</div>`;
                  list.innerHTML += html;
              });
              list.scrollTop = list.scrollHeight;
          });
    }

    function sendPrivateMsg() {
        const input = document.getElementById('privateInput');
        const text = input.value.trim();
        if(!text || !activeConversationId) return;

        db.collection('direct_messages').add({
            conversationId: activeConversationId,
            text: text,
            senderId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
    }

    // Update Profile Photo
    function uploadProfilePic() {
        const file = document.getElementById('newProfileImg').files[0];
        if(!file) return;
        if(file.size > 1000000) return alert("File too large!");

        showLoading(true);
        const reader = new FileReader();
        reader.onload = (e) => {
            db.collection('users').doc(currentUser.uid).update({ photo: e.target.result }).then(() => {
                showLoading(false);
                alert("Updated!");
            });
        }
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>
