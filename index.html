<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lite Social</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- Performance Optimization & Reset --- */
        :root { --primary: #1877f2; --bg: #f0f2f5; --white: #ffffff; --text: #050505; --gray: #65676b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- Components --- */
        .btn { border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-text { background: none; color: var(--gray); }
        .avatar { border-radius: 50%; object-fit: cover; background: #ddd; }
        
        /* --- Login Screen --- */
        #loginScreen { position: fixed; inset: 0; background: var(--white); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .logo { color: var(--primary); font-size: 40px; font-weight: 800; letter-spacing: -1px; margin-bottom: 20px; }

        /* --- Layout --- */
        #appInterface { display: none; flex-direction: column; height: 100%; }
        .header { background: var(--white); padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); font-size: 22px; }
        .content { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
        .tab-page { display: none; padding-bottom: 60px; } /* Bottom padding for nav */
        .active { display: block; }

        /* --- Feed & Posts --- */
        .create-box { background: var(--white); padding: 15px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .post-input { flex: 1; background: var(--bg); border: none; padding: 10px 15px; border-radius: 20px; font-size: 15px; }
        
        .post-card { background: var(--white); margin-bottom: 8px; padding-top: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .pc-head { padding: 0 15px 10px; display: flex; justify-content: space-between; align-items: flex-start; }
        .pc-user { display: flex; gap: 10px; align-items: center; }
        .pc-meta h4 { margin: 0; font-size: 15px; color: var(--text); }
        .pc-meta span { font-size: 12px; color: var(--gray); }
        .pc-body { padding: 0 15px 10px; font-size: 15px; line-height: 1.4; }
        .pc-img { width: 100%; display: block; max-height: 500px; object-fit: cover; background: #eee; }
        .pc-actions { border-top: 1px solid #eee; display: flex; padding: 5px 0; }
        .act-btn { flex: 1; padding: 10px; display: flex; justify-content: center; align-items: center; gap: 6px; color: var(--gray); font-weight: 500; font-size: 14px; }
        .liked { color: var(--primary); }

        /* --- Comments (Bottom Sheet) --- */
        #commentModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500; display: none; justify-content: center; align-items: flex-end; }
        .cm-box { background: var(--white); width: 100%; height: 75%; border-radius: 15px 15px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cm-head { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .cm-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .cm-item { display: flex; gap: 10px; }
        .cm-bubble { background: var(--bg); padding: 8px 12px; border-radius: 12px; }
        .cm-input-box { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; }

        /* --- Private Chat (Full Screen) --- */
        #chatScreen { position: fixed; inset: 0; background: var(--white); z-index: 2500; display: none; flex-direction: column; }
        .chat-head { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 16px; }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: var(--bg); }
        .msg { padding: 8px 14px; border-radius: 18px; max-width: 75%; font-size: 15px; word-wrap: break-word; }
        .msg-me { background: var(--primary); color: var(--white); align-self: flex-end; }
        .msg-other { background: var(--white); color: var(--text); align-self: flex-start; border: 1px solid #ddd; }
        .chat-foot { padding: 10px; background: var(--white); display: flex; gap: 10px; border-top: 1px solid #eee; }

        /* --- Friend List --- */
        .friend-row { padding: 12px 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .friend-row:active { background: var(--bg); }

        /* --- Profile --- */
        .profile-box { padding: 30px 15px; text-align: center; background: var(--white); }
        .profile-input { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 80%; text-align: center; margin: 10px 0; font-size: 16px; }

        /* --- Navigation --- */
        .nav { position: fixed; bottom: 0; width: 100%; height: 55px; background: var(--white); border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; }
        .nav-item { font-size: 24px; color: var(--gray); cursor: pointer; padding: 10px; }
        .nav-active { color: var(--primary); }

        /* Loading */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>
    
    <div id="loginScreen">
        <div class="logo">Social Lite</div>
        <button class="btn btn-primary" onclick="doLogin()">Log In with Google</button>
    </div>

    <div id="appInterface">
        <div class="header">
            <span>Social Lite</span>
            <img id="myThumb" class="avatar" style="width:32px; height:32px;" onclick="switchTab('profile')">
        </div>

        <div class="content">
            <div id="tab-home" class="tab-page active">
                <div class="create-box">
                    <div class="input-row">
                        <img id="postThumb" class="avatar" style="width:40px; height:40px;">
                        <input type="text" id="postText" class="post-input" placeholder="What's on your mind?">
                    </div>
                    <img id="previewImg" style="width:100%; border-radius:8px; display:none; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label for="postFile" style="color:#45bd62; font-weight:600; cursor:pointer; font-size:14px;">üì∑ Photo</label>
                        <input type="file" id="postFile" accept="image/*" style="display:none" onchange="previewFile()">
                        <button class="btn btn-primary" onclick="submitPost()">Post</button>
                    </div>
                </div>
                <div id="feed"></div>
            </div>

            <div id="tab-friends" class="tab-page">
                <div id="friendList"></div>
            </div>

            <div id="tab-profile" class="tab-page">
                <div class="profile-box">
                    <img id="bigProfile" class="avatar" style="width:100px; height:100px; border:3px solid var(--primary);">
                    <br><br>
                    <label style="color:var(--primary); font-weight:bold; cursor:pointer;">
                        Change Photo
                        <input type="file" id="newProfilePic" accept="image/*" style="display:none" onchange="updateProfilePic()">
                    </label>
                    <br><br>
                    <input type="text" id="editName" class="profile-input">
                    <br>
                    <button class="btn btn-primary" onclick="updateName()">Save Name</button>
                    <br><br><br>
                    <button class="btn" style="background:#eee; color:red;" onclick="doLogout()">Log Out</button>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item nav-active" onclick="switchTab('home')">üè†</div>
            <div class="nav-item" onclick="switchTab('friends')">üë•</div>
            <div class="nav-item" onclick="switchTab('profile')">üë§</div>
        </div>
    </div>

    <div id="commentModal">
        <div class="cm-box">
            <div class="cm-head">Comments <span onclick="closeComments()" style="cursor:pointer">‚úï</span></div>
            <div class="cm-list" id="commentList"></div>
            <div class="cm-input-box">
                <input type="text" id="cmtInput" class="post-input" placeholder="Write a comment...">
                <button class="btn btn-text" onclick="postComment()" style="color:var(--primary)">‚û§</button>
            </div>
        </div>
    </div>

    <div id="chatScreen">
        <div class="chat-head">
            <span onclick="closeChat()" style="font-size:24px; cursor:pointer; padding-right:10px;">‚Üê</span>
            <img id="chatUserPic" class="avatar" style="width:32px; height:32px;">
            <span id="chatUserName">User</span>
        </div>
        <div class="chat-body" id="msgList"></div>
        <div class="chat-foot">
            <input type="text" id="msgInput" class="post-input" placeholder="Message...">
            <button class="btn btn-text" onclick="sendMsg()" style="color:var(--primary); font-size:20px;">‚û§</button>
        </div>
    </div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
      authDomain: "chat-27f21.firebaseapp.com",
      projectId: "chat-27f21",
      storageBucket: "chat-27f21.firebasestorage.app",
      messagingSenderId: "582814616396",
      appId: "1:582814616396:web:251660e2a50635bc70dde9"
    };
    const ADMIN_EMAIL = "mmtintaungkhaing@gmail.com"; 

    // --- 2. INIT FIREBASE ---
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State Variables
    let currentUser = null;
    let myData = {};
    let activeChatID = null;
    let activePostID = null;
    let commentUnsub = null; // To stop listening when modal closes
    let chatUnsub = null;    // To stop listening when chat closes

    // --- 3. AUTH & USER DATA ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appInterface').style.display = 'flex';
            
            // Realtime User Data
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    myData = doc.data();
                } else {
                    myData = { 
                        name: user.displayName, 
                        photo: user.photoURL, 
                        email: user.email, 
                        uid: user.uid,
                        isAdmin: (user.email === ADMIN_EMAIL)
                    };
                    doc.ref.set(myData);
                }
                updateUI();
                loadFeed();
                loadFriends();
            });
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appInterface').style.display = 'none';
        }
    });

    const doLogin = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    const doLogout = () => auth.signOut();
    const updateUI = () => {
        const els = ['myThumb', 'postThumb', 'bigProfile'];
        els.forEach(id => document.getElementById(id).src = myData.photo);
        document.getElementById('editName').value = myData.name;
    };

    // --- 4. NAVIGATION ---
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
        
        document.getElementById('tab-'+tab).classList.add('active');
        // Simple index mapping for nav highlights
        const idx = tab==='home'?0 : tab==='friends'?1 : 2;
        document.querySelectorAll('.nav-item')[idx].classList.add('nav-active');
    };

    // --- 5. FEED & POSTS ---
    const previewFile = () => {
        const file = document.getElementById('postFile').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('previewImg').src = e.target.result; document.getElementById('previewImg').style.display = 'block'; }
            r.readAsDataURL(file);
        }
    };

    const submitPost = async () => {
        const text = document.getElementById('postText').value;
        const imgParams = document.getElementById('previewImg').style.display === 'block' ? document.getElementById('previewImg').src : null;
        
        if(!text && !imgParams) return;
        
        document.getElementById('loader').style.display = 'flex';
        await db.collection('posts').add({
            text: text,
            image: imgParams,
            uid: currentUser.uid,
            author: myData.name,
            face: myData.photo,
            time: firebase.firestore.FieldValue.serverTimestamp(),
            likes: [],
            isAdmin: myData.isAdmin || false
        });
        
        document.getElementById('loader').style.display = 'none';
        document.getElementById('postText').value = "";
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('postFile').value = "";
    };

    const loadFeed = () => {
        db.collection('posts').orderBy('time', 'desc').onSnapshot(snap => {
            const div = document.getElementById('feed');
            div.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                const isLiked = p.likes && p.likes.includes(currentUser.uid);
                const badge = p.isAdmin ? `<span style="color:var(--primary);margin-left:4px">‚úì</span>` : ``;
                const del = (currentUser.uid === p.uid || myData.isAdmin) ? `<span onclick="delPost('${doc.id}')" style="color:red; cursor:pointer;">üóë</span>` : "";

                div.innerHTML += `
                    <div class="post-card">
                        <div class="pc-head">
                            <div class="pc-user" onclick="startChat('${p.uid}', '${p.author}', '${p.face}')">
                                <img src="${p.face}" class="avatar" style="width:40px; height:40px;">
                                <div class="pc-meta"><h4>${p.author} ${badge}</h4><span>${p.time?new Date(p.time.toDate()).toLocaleTimeString():''}</span></div>
                            </div>
                            ${del}
                        </div>
                        <div class="pc-body">
                            <p>${p.text||""}</p>
                            ${p.image ? `<img src="${p.image}" class="pc-img">` : ""}
                        </div>
                        <div class="pc-actions">
                            <div class="act-btn ${isLiked?'liked':''}" onclick="likePost('${doc.id}', ${isLiked})">
                                ${isLiked ? '‚ô• Liked' : '‚ô° Like'} (${p.likes?p.likes.length:0})
                            </div>
                            <div class="act-btn" onclick="openComments('${doc.id}')">üí¨ Comment</div>
                        </div>
                    </div>
                `;
            });
        });
    };

    const delPost = (id) => confirm("Delete?") && db.collection('posts').doc(id).delete();
    const likePost = (id, loved) => {
        db.collection('posts').doc(id).update({
            likes: loved ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
    };

    // --- 6. COMMENTS (FIXED) ---
    const openComments = (pid) => {
        activePostID = pid;
        document.getElementById('commentModal').style.display = 'flex';
        // Real-time listener for comments
        commentUnsub = db.collection('comments').where('pid', '==', pid).orderBy('time', 'asc').onSnapshot(snap => {
            const div = document.getElementById('commentList');
            div.innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                div.innerHTML += `
                    <div class="cm-item">
                        <img src="${c.face}" class="avatar" style="width:30px; height:30px;">
                        <div class="cm-bubble">
                            <div style="font-weight:bold; font-size:13px">${c.author}</div>
                            <div>${c.text}</div>
                        </div>
                    </div>
                `;
            });
            div.scrollTop = div.scrollHeight;
        });
    };

    const closeComments = () => {
        document.getElementById('commentModal').style.display = 'none';
        if(commentUnsub) commentUnsub(); // Stop listening
    };

    const postComment = () => {
        const txt = document.getElementById('cmtInput').value;
        if(!txt) return;
        db.collection('comments').add({
            pid: activePostID, text: txt, uid: currentUser.uid,
            author: myData.name, face: myData.photo,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('cmtInput').value = "";
    };

    // --- 7. CHAT (FIXED) ---
    const loadFriends = () => {
        db.collection('users').onSnapshot(snap => {
            const div = document.getElementById('friendList');
            div.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.uid !== currentUser.uid) {
                    div.innerHTML += `
                        <div class="friend-row" onclick="startChat('${u.uid}', '${u.name}', '${u.photo}')">
                            <img src="${u.photo}" class="avatar" style="width:40px; height:40px;">
                            <span style="font-weight:600; font-size:15px; flex:1">${u.name}</span>
                            <span style="color:var(--primary)">üí¨</span>
                        </div>
                    `;
                }
            });
        });
    };

    const startChat = (uid, name, pic) => {
        // Create Unique Chat ID
        const ids = [currentUser.uid, uid].sort();
        activeChatID = ids.join("_");
        
        document.getElementById('chatUserName').innerText = name;
        document.getElementById('chatUserPic').src = pic;
        document.getElementById('chatScreen').style.display = 'flex';

        chatUnsub = db.collection('messages').where('chatID', '==', activeChatID).orderBy('time', 'asc').onSnapshot(snap => {
            const div = document.getElementById('msgList');
            div.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                const type = m.uid === currentUser.uid ? 'msg-me' : 'msg-other';
                div.innerHTML += `<div class="msg ${type}">${m.text}</div>`;
            });
            div.scrollTop = div.scrollHeight;
        });
    };

    const closeChat = () => {
        document.getElementById('chatScreen').style.display = 'none';
        if(chatUnsub) chatUnsub();
    };

    const sendMsg = () => {
        const txt = document.getElementById('msgInput').value;
        if(!txt) return;
        db.collection('messages').add({
            chatID: activeChatID, text: txt, uid: currentUser.uid,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('msgInput').value = "";
    };

    // --- 8. PROFILE ---
    const updateName = () => {
        db.collection('users').doc(currentUser.uid).update({ name: document.getElementById('editName').value })
        .then(() => alert("Name Updated"));
    };
    const updateProfilePic = () => {
        const file = document.getElementById('newProfilePic').files[0];
        if(!file) return;
        if(file.size > 1024 * 1024) return alert("File too big! Max 1MB"); // 1MB Limit
        
        const r = new FileReader();
        r.onload = e => {
            db.collection('users').doc(currentUser.uid).update({ photo: e.target.result })
            .then(() => alert("Photo Updated"));
        };
        r.readAsDataURL(file);
    };

</script>
</body>
</html>
