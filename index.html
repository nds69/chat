<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social69</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- Theme Variables --- */
        :root {
            --primary: #6C5DD3;
            --primary-light: #A094E3;
            --accent: #FF754C;
            --bg-body: #F0F2F5;
            --bg-card: #FFFFFF;
            --text-main: #11142D;
            --text-gray: #808191;
            --input-bg: #F8F9FB;
            --border-color: #f0f0f0;
            --nav-bg: #FFFFFF;
            --border-radius: 20px;
        }

        /* DARK MODE */
        body.dark-mode {
            --primary: #8E84F5;
            --primary-light: #5a4ad1;
            --accent: #FF754C;
            --bg-body: #121212;
            --bg-card: #1E1E1E;
            --text-main: #E0E0E0;
            --text-gray: #A0A0A0;
            --input-bg: #2C2C2C;
            --border-color: #333333;
            --nav-bg: #1E1E1E;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-body); 
            margin: 0; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 50% { transform: scale(1.2); } }
        @keyframes toastSlide { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

        /* --- Pull to Refresh --- */
        #ptr-spinner {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 25px; height: 25px; border-radius: 50%;
            border: 2px solid var(--border-color); border-top-color: var(--primary);
            animation: spin 0.8s infinite linear;
            display: none; z-index: 900; background: var(--bg-card); padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        @keyframes spin { to { transform: translateX(-50%) rotate(360deg); } }

        /* --- Components --- */
        .btn { border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(108, 93, 211, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-ghost { background: transparent; color: var(--text-gray); }
        
        .avatar { border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; border: 2px solid var(--bg-body); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- Layout --- */
        .header { 
            background: var(--bg-card);
            padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; 
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border-color);
        }
        .header-title { font-size: 20px; font-weight: 800; color: var(--primary); }

        /* ðŸ”¥ Scrollable Content Wrapper */
        .content-wrapper { 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 120px; /* Extra padding for scrolling */
            position: relative; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }
        .tab-page { display: none; padding: 15px; animation: fadeIn 0.3s ease; min-height: 100%; }
        .active-tab { display: block; }

        /* --- Post Create --- */
        .create-box { background: var(--bg-card); border-radius: var(--border-radius); padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .input-row { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 15px; }
        .post-input { flex: 1; background: var(--input-bg); border: none; padding: 12px 15px; border-radius: 12px; font-size: 15px; color: var(--text-main); transition: 0.2s; resize: none; font-family: inherit; }
        .post-input:focus { background: var(--bg-card); box-shadow: inset 0 0 0 2px var(--primary-light); }
        .action-row { display: flex; justify-content: space-between; align-items: center; }
        .photo-trigger { color: var(--primary); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 5px 10px; border-radius: 8px; background: rgba(108, 93, 211, 0.1); }

        /* --- Feed Post --- */
        .post-card { background: var(--bg-card); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 20px rgba(0,0,0,0.02); transition: background 0.3s; }
        .pc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .pc-user { display: flex; gap: 10px; align-items: center; }
        .pc-name { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 4px; color: var(--text-main); }
        .admin-badge { color: var(--primary); font-size: 14px; }
        .pc-time { font-size: 11px; color: var(--text-gray); margin-top: 2px; }
        .pc-text { font-size: 15px; line-height: 1.5; margin-bottom: 10px; color: var(--text-main); word-wrap: break-word; white-space: pre-wrap; }
        .pc-text a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .pc-img { width: 100%; border-radius: 12px; margin-top: 10px; max-height: 400px; object-fit: cover; }
        
        .pc-stats { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-gray); margin: 15px 0 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .pc-actions { display: flex; justify-content: space-between; }
        .pc-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-gray); font-weight: 600; padding: 8px; border-radius: 8px; cursor: pointer; }
        .pc-btn:active { background: var(--input-bg); }
        .pc-btn.liked { color: var(--accent); }
        .pc-btn.liked i { animation: pop 0.3s ease; }

        /* --- Floating Navigation --- */
        .nav-dock { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--nav-bg); width: 90%; max-width: 400px; height: 65px;
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 2000; padding: 0 10px; border: 1px solid var(--border-color);
        }
        .nav-item { font-size: 24px; color: var(--text-gray); padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); background: rgba(108, 93, 211, 0.1); transform: translateY(-5px); }
        .nav-indicator { width: 4px; height: 4px; background: var(--primary); border-radius: 50%; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); display: none; }
        .nav-item.active .nav-indicator { display: block; }
        
        /* Notification Badge Style */
        .nav-badge { 
            width: 10px; height: 10px; background: #FF4D4F; border-radius: 50%; 
            position: absolute; top: 10px; right: 10px; border: 2px solid var(--nav-bg);
            display: none; z-index: 10;
        }

        /* --- Comments Overlay --- */
        .overlay-screen { position: fixed; inset: 0; background: var(--bg-card); z-index: 3000; display: none; flex-direction: column; animation: fadeIn 0.2s; color: var(--text-main); }
        .os-header { height: 60px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border-color); gap: 15px; }
        .os-title { font-weight: 700; font-size: 18px; }
        .os-body { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-body); display: flex; flex-direction: column; gap: 10px; }
        .os-input { padding: 15px; background: var(--bg-card); border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 15px; position: relative; word-wrap: break-word; white-space: pre-wrap; display: flex; flex-direction: column; }
        .bubble-name { font-size: 11px; font-weight: 700; opacity: 0.6; margin-bottom: 2px; line-height: 1.2; }
        .bubble-content { line-height: 1.4; }
        
        .bubble-me { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble-me .bubble-name { color: rgba(255,255,255,0.8); }
        
        .bubble-other { background: var(--bg-card); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bubble-other .bubble-name { color: var(--text-gray); }

        /* --- Friend List Item --- */
        .friend-card { background: var(--bg-card); padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        
        /* --- Profile Styles --- */
        .profile-header { background: var(--bg-card); border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.03); position: relative; margin-bottom: 20px;}
        .dark-mode-toggle { position: absolute; top: 15px; right: 15px; background: var(--input-bg); padding: 8px; border-radius: 50%; cursor: pointer; color: var(--text-main); }
        
        /* ðŸ”¥ About Card Style */
        .about-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.02);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .about-row {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .about-row:last-child { border-bottom: none; }
        .about-icon {
            width: 40px; height: 40px;
            background: rgba(108, 93, 211, 0.1);
            color: var(--primary);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; flex-shrink: 0;
        }
        .about-info { flex: 1; overflow: hidden; }
        .about-info h4 { margin: 0 0 4px 0; font-size: 13px; color: var(--text-gray); }
        .about-info p { margin: 0; font-size: 15px; font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- GUEST CARD LAYOUT --- */
        #profile-guest-view {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 20px;
        }

        .guest-welcome-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 25px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(108, 93, 211, 0.4);
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }
        .guest-icon { font-size: 60px; margin-bottom: 15px; }
        .guest-title { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
        .guest-desc { font-size: 14px; opacity: 0.9; margin-bottom: 30px; line-height: 1.6; }
        .login-btn-group { display: flex; flex-direction: column; gap: 12px; }
        .social-login-btn {
            background: white; color: var(--text-main);
            padding: 14px; border-radius: 15px; border: none;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 15px;
        }

        /* --- FEED GUEST BANNER --- */
        #guestFeedBanner {
            display: none; 
            text-align: center; 
            padding: 15px; 
            margin-bottom: 20px;
            background: rgba(108, 93, 211, 0.1);
            border-radius: 15px;
            color: var(--primary);
            font-weight: 500;
        }

        /* --- MODAL & TOAST --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 4000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--bg-card); width: 90%; max-width: 400px; padding: 25px;
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; gap: 15px; color: var(--text-main);
        }
        .modal-title { font-size: 18px; font-weight: 800; }
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        
        /* ðŸ”¥ Profile Edit Modal Specific */
        .profile-edit-center { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
        .pe-avatar-wrapper { position: relative; width: 100px; height: 100px; margin-bottom: 15px; }
        .pe-btn-cam { 
            position: absolute; bottom: 0; right: 0; background: var(--primary); color: white;
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; border: 3px solid var(--bg-card);
        }
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: var(--text-gray); margin-bottom: 5px; margin-left: 5px; }
        .input-group { margin-bottom: 10px; }

        /* ðŸ”¥ New Position for Logout Button */
        .logout-btn-simple {
            background: transparent; color: #ff4d4f; border: 1px solid rgba(255, 77, 79, 0.2);
            padding: 8px 15px; border-radius: 12px; font-weight: 600; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; transition: 0.2s; margin: 0 auto 15px;
        }
        .logout-btn-simple:active { background: rgba(255, 77, 79, 0.1); transform: scale(0.98); }

        #toastBox {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(40, 40, 45, 0.95); color: white;
            padding: 12px 25px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 6000; pointer-events: none; opacity: 0; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        #toastBox.show { animation: toastSlide 0.5s forwards; }
        .toast-icon { background: var(--primary); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    </style>
</head>
<body>

    <div id="ptr-spinner"></div>

    <div id="toastBox">
        <div class="toast-icon"><i class="ph-bold ph-check"></i></div>
        <span id="toastMsg">Success</span>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Edit Post</div>
            <textarea id="editModalInput" class="post-input" rows="5" placeholder="Update your post..."></textarea>
            <div class="modal-btns">
                <button class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditPost()">Save Update</button>
            </div>
        </div>
    </div>

    <div id="profileEditModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="text-align:center;">Edit Profile</div>
            
            <div class="profile-edit-center">
                <div class="pe-avatar-wrapper">
                    <img id="modalProfileThumb" class="avatar" style="width:100%; height:100%;">
                    <label for="modalNewProfilePic" class="pe-btn-cam">
                        <i class="ph-bold ph-camera"></i>
                    </label>
                    <input type="file" id="modalNewProfilePic" accept="image/*" style="display:none" onchange="previewProfileModalPic()">
                </div>
            </div>

            <div class="input-group">
                <label>Display Name</label>
                <input type="text" id="modalEditName" class="post-input" placeholder="e.g. John Doe">
            </div>

            <div class="input-group">
                <label>Bio</label>
                <input type="text" id="modalEditBio" class="post-input" placeholder="Short description...">
            </div>

            <div class="input-group">
                <label>Website</label>
                <input type="text" id="modalEditWebsite" class="post-input" placeholder="https://example.com">
            </div>

            <div class="modal-btns" style="justify-content: space-between; margin-top:10px;">
                <button class="btn btn-ghost" onclick="closeProfileModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfileChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="appInterface" style="display:flex; flex-direction:column; height:100%;">
        <div class="header">
            <div class="header-title">Social69</div>
            
            <img id="myHeaderThumb" class="avatar" style="width:35px; height:35px; cursor:pointer;" onclick="openProfileModal()">
        </div>

        <div class="content-wrapper" id="contentArea">
            
            <div id="tab-home" class="tab-page active-tab">
                <div id="loggedInCreateBox" class="create-box" style="display:none;">
                    <div class="input-row">
                        <img id="postThumb" class="avatar" style="width:40px; height:40px;">
                        <textarea id="postInput" class="post-input" placeholder="What's happening?" rows="3"></textarea>
                    </div>
                    <img id="previewImg" style="width:100%; border-radius:12px; display:none; margin-bottom:15px;">
                    <div class="action-row">
                        <label for="postFile" class="photo-trigger">
                            <i class="ph ph-image"></i> Photo
                        </label>
                        <input type="file" id="postFile" accept="image/*" style="display:none" onchange="previewFile()">
                        <button class="btn btn-primary" onclick="submitPost()">Post</button>
                    </div>
                </div>

                <div id="guestFeedBanner">
                    <i class="ph-fill ph-lock-key" style="font-size:24px; vertical-align:middle; margin-right:5px;"></i>
                    Login to post & interact!
                </div>

                <div id="feedContainer"></div>
                <div style="text-align:center; padding:20px; color:#ccc; font-size:12px;">End of Feed</div>
            </div>

            <div id="tab-friends" class="tab-page">
                <h3 style="margin:0 0 15px 0;">People</h3>
                <div id="friendList">
                    <div style="text-align:center; padding:20px; color:var(--text-gray);">Loading...</div>
                </div>
            </div>

            <div id="tab-profile" class="tab-page">
                
                <div style="text-align:right; margin-bottom:10px;">
                    <button class="btn btn-ghost" onclick="toggleTheme()" style="background:var(--bg-card);">
                        <i id="themeIcon" class="ph-fill ph-moon" style="font-size:20px;"></i> Theme
                    </button>
                </div>

                <div id="profile-guest-view">
                    <div class="guest-welcome-card">
                        <i class="ph-fill ph-planet guest-icon"></i>
                        <div class="guest-title">Welcome to Social69</div>
                        <div class="guest-desc">
                            Join our community to share your moments,<br>
                            connect with friends, and vibe together.
                        </div>
                        <div class="login-btn-group">
                            <button class="social-login-btn" onclick="loginGoogle()">
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                                Continue with Google
                            </button>
                            <button class="social-login-btn" onclick="loginGithub()">
                                <i class="ph-fill ph-github-logo" style="font-size:22px;"></i>
                                Continue with GitHub
                            </button>
                        </div>
                    </div>
                </div>

                <div id="profile-user-view" style="display:none;">
                    <div class="profile-header">
                        <img id="profilePic" class="avatar" style="width:100px; height:100px; border:4px solid var(--bg-body);">
                        <h2 id="profileNameDisplay" style="margin:15px 0 5px;">User Name</h2>
                        <div style="color:var(--text-gray); font-size:14px; margin-bottom:10px;">
                            Tap the top-right avatar to edit profile
                        </div>
                        
                        <button class="logout-btn-simple" onclick="auth.signOut()">
                            <i class="ph-bold ph-sign-out"></i> Log Out
                        </button>
                    </div>

                    <h3 style="margin-bottom:15px;">About</h3>
                    <div class="about-card">
                        <div class="about-row">
                            <div class="about-icon"><i class="ph-fill ph-text-aa"></i></div>
                            <div class="about-info">
                                <h4>Bio</h4>
                                <p id="profileBio">No bio yet</p>
                            </div>
                        </div>
                        <div class="about-row">
                            <div class="about-icon"><i class="ph-fill ph-globe"></i></div>
                            <div class="about-info">
                                <h4>Website</h4>
                                <p id="profileWebsite">No website</p>
                            </div>
                        </div>
                        <div class="about-row" id="emailRow" style="display:none">
                            <div class="about-icon"><i class="ph-fill ph-envelope-simple"></i></div>
                            <div class="about-info">
                                <h4>Email (Admin Only)</h4>
                                <p id="profileEmail">user@example.com</p>
                            </div>
                        </div>
                        <div class="about-row">
                            <div class="about-icon"><i class="ph-fill ph-identification-card"></i></div>
                            <div class="about-info">
                                <h4>Status</h4>
                                <p id="profileStatus">Member</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="height:50px;"></div> </div>

            </div>

        </div>

        <div class="nav-dock">
            <div class="nav-item active" onclick="switchTab('home', this)">
                <i class="ph-fill ph-house"></i>
                <div class="nav-indicator"></div>
            </div>
            <div class="nav-item" onclick="switchTab('friends', this)">
                <i class="ph-fill ph-users"></i>
                <div id="chatBadge" class="nav-badge"></div>
                <div class="nav-indicator"></div>
            </div>
            <div class="nav-item" onclick="switchTab('profile', this)">
                <i class="ph-fill ph-user"></i>
                <div class="nav-indicator"></div>
            </div>
        </div>
    </div>

    <div id="overlayScreen" class="overlay-screen">
        <div class="os-header">
            <i class="ph ph-arrow-left" style="font-size:24px; cursor:pointer;" onclick="closeOverlay()"></i>
            <div class="os-title" id="overlayTitle">Comments</div>
        </div>
        <div id="overlayBody" class="os-body"></div>
        <div class="os-input">
            <input type="text" id="overlayInput" class="post-input" placeholder="Type here...">
            <button class="btn btn-primary" style="padding:10px;" onclick="handleOverlaySend()">
                <i class="ph-fill ph-paper-plane-right"></i>
            </button>
        </div>
    </div>

<script>
    // ðŸ›¡ï¸ SECURITY
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
    }

    // âš ï¸ CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
      authDomain: "chat-27f21.firebaseapp.com",
      projectId: "chat-27f21",
      storageBucket: "chat-27f21.firebasestorage.app",
      messagingSenderId: "582814616396",
      appId: "1:582814616396:web:251660e2a50635bc70dde9"
    };
    const ADMIN_EMAIL = "mmtintaungkhaing@gmail.com"; 

    // --- SETUP ---
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let myData = {};
    let overlayMode = ''; 
    let activeTargetId = null; 
    let chatReceiverId = null;
    let unsubOverlay = null;
    let feedUnsubscribe = null;
    let unreadListener = null;
    let editingPostId = null;
    let unreadSenders = new Set();
    let userCache = {};

    // --- THEME MANAGEMENT ---
    const checkTheme = () => {
        const isDark = localStorage.getItem('theme') === 'dark';
        if (isDark) {
            document.body.classList.add('dark-mode');
            document.getElementById('themeIcon').classList.replace('ph-moon', 'ph-sun');
        }
    };
    checkTheme();

    window.toggleTheme = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        const icon = document.getElementById('themeIcon');
        if(isDark) icon.classList.replace('ph-moon', 'ph-sun');
        else icon.classList.replace('ph-sun', 'ph-moon');
    };

    window.showToast = (msg) => {
        const box = document.getElementById('toastBox');
        document.getElementById('toastMsg').innerText = msg;
        box.classList.add('show');
        setTimeout(() => box.classList.remove('show'), 3000);
    };

    const makeLinksClickable = (text) => {
        if (!text) return '';
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`);
    };

    // --- PULL TO REFRESH ---
    let pStart = {x:0, y:0};
    const contentArea = document.getElementById('contentArea');
    const ptrSpinner = document.getElementById('ptr-spinner');
    contentArea.addEventListener('touchstart', e => { pStart.y = e.touches[0].clientY; });
    contentArea.addEventListener('touchmove', e => {
        let y = e.touches[0].clientY;
        if(contentArea.scrollTop === 0 && y > pStart.y + 70) ptrSpinner.style.display = 'block';
    });
    contentArea.addEventListener('touchend', e => {
        if(ptrSpinner.style.display === 'block') {
            loadFeed(); 
            setTimeout(() => { ptrSpinner.style.display = 'none'; }, 800);
        }
    });

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    if (data.isBanned) {
                        auth.signOut();
                        alert("Your account has been suspended by Admin.");
                        window.location.reload();
                        return;
                    }
                    currentUser = user;
                    myData = data;

                    document.getElementById('loggedInCreateBox').style.display = 'block';
                    document.getElementById('guestFeedBanner').style.display = 'none';
                    document.getElementById('profile-guest-view').style.display = 'none'; 
                    document.getElementById('profile-user-view').style.display = 'block'; 

                    updateUI();
                    loadFriends();
                    startNotificationListener();
                } else {
                    myData = { 
                        name: user.displayName, photo: user.photoURL, 
                        uid: user.uid, email: user.email, 
                        isAdmin: (user.email === ADMIN_EMAIL),
                        isBanned: false,
                        bio: "Hello World",
                        website: ""
                    };
                    doc.ref.set(myData);
                    updateUI();
                }
            });
        } else {
            currentUser = null;
            myData = {};
            if(unreadListener) unreadListener();
            document.getElementById('chatBadge').style.display = 'none';

            document.getElementById('loggedInCreateBox').style.display = 'none';
            document.getElementById('guestFeedBanner').style.display = 'block';
            document.getElementById('profile-guest-view').style.display = 'flex'; 
            document.getElementById('profile-user-view').style.display = 'none';
            
            document.getElementById('myHeaderThumb').src = "https://ui-avatars.com/api/?name=S+6&background=6C5DD3&color=fff&rounded=true&bold=true&size=128";
            document.getElementById('friendList').innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-gray);'>Please login to see friends.</div>";
        }
        loadFeed();
    });

    const loginGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    const loginGithub = () => auth.signInWithPopup(new firebase.auth.GithubAuthProvider()).catch(e => alert("Please enable GitHub in Firebase Console!"));
    
    const updateUI = () => {
        if(!currentUser) return;
        const pic = myData.photo || 'https://via.placeholder.com/100';
        ['myHeaderThumb', 'postThumb', 'profilePic'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.src = pic;
        });
        document.getElementById('profileNameDisplay').innerText = myData.name;
        
        // ðŸ”¥ Update About Card
        document.getElementById('profileBio').innerText = myData.bio || 'No bio yet';
        
        const webEl = document.getElementById('profileWebsite');
        if(myData.website) {
            webEl.innerHTML = `<a href="${myData.website}" target="_blank" style="color:var(--primary); text-decoration:none;">${myData.website}</a>`;
        } else {
            webEl.innerText = "No website";
        }

        document.getElementById('profileEmail').innerText = myData.email || 'No Email';
        document.getElementById('profileStatus').innerText = myData.isAdmin ? 'Admin' : 'Member';
        
        // Hide Email row if not admin
        document.getElementById('emailRow').style.display = myData.isAdmin ? 'flex' : 'none';
    };

    window.switchTab = (tab, el) => {
        document.querySelectorAll('.tab-page').forEach(t => t.classList.remove('active-tab'));
        document.getElementById('tab-'+tab).classList.add('active-tab');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
    };

    // --- NOTIFICATION SYSTEM ---
    const startNotificationListener = () => {
        if(unreadListener) unreadListener();
        
        unreadListener = db.collection('messages')
            .where('receiverId', '==', currentUser.uid)
            .where('isRead', '==', false)
            .onSnapshot(snap => {
                unreadSenders.clear();
                snap.forEach(d => unreadSenders.add(d.data().sender));
                
                const badge = document.getElementById('chatBadge');
                badge.style.display = snap.size > 0 ? 'block' : 'none';
                
                document.querySelectorAll('.friend-noti-dot').forEach(el => el.style.display = 'none');
                unreadSenders.forEach(uid => {
                    const dot = document.getElementById('noti-' + uid);
                    if(dot) dot.style.display = 'block';
                });

            }, error => {
                console.error("Notification listener error:", error);
            });
    };

    const markMessagesAsRead = (senderId) => {
        db.collection('messages')
          .where('chatId', '==', [currentUser.uid, senderId].sort().join("_"))
          .where('receiverId', '==', currentUser.uid)
          .where('isRead', '==', false)
          .get()
          .then(snap => {
              if(snap.empty) return;
              const batch = db.batch();
              snap.forEach(doc => batch.update(doc.ref, { isRead: true }));
              batch.commit();
          });
    };

    // --- POSTS ---
    const previewFile = () => {
        const file = document.getElementById('postFile').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('previewImg').src = e.target.result; document.getElementById('previewImg').style.display = 'block'; }
            r.readAsDataURL(file);
        }
    };

    const submitPost = async () => {
        if(!currentUser) return showToast("Please Login First!");
        const text = document.getElementById('postInput').value;
        const img = document.getElementById('previewImg').style.display === 'block' ? document.getElementById('previewImg').src : null;
        if(!text && !img) return;

        try {
            await db.collection('posts').add({
                text, image: img, uid: currentUser.uid,
                authorName: myData.name, authorPhoto: myData.photo,
                isAdmin: myData.isAdmin || false, likes: [],
                commentCount: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('postInput').value = "";
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('previewImg').src = "";
            showToast("Post Sent!");
        } catch(e) {
            alert("Error: You might be banned or restricted.");
        }
    };

    window.toggleBanUser = (uid, currentStatus, name) => {
        if(!myData.isAdmin) return;
        const action = currentStatus ? "Unban" : "Ban";
        if(confirm(`Are you sure you want to ${action} ${name}?`)) {
            db.collection('users').doc(uid).update({ isBanned: !currentStatus })
            .then(() => showToast(`User ${action}ned!`));
        }
    };

    // --- FEED ---
    const loadFeed = () => {
        if(feedUnsubscribe) feedUnsubscribe(); 
        feedUnsubscribe = db.collection('posts')
            .orderBy('timestamp', 'desc')
            .onSnapshot(snap => {
                const container = document.getElementById('feedContainer');
                container.innerHTML = "";
                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    const isLiked = currentUser && p.likes && p.likes.includes(currentUser.uid);
                    const likeIcon = isLiked ? 'ph-fill ph-heart' : 'ph ph-heart';
                    const adminIcon = p.isAdmin ? `<i class="ph-fill ph-seal-check admin-badge"></i>` : '';
                    
                    const isOwner = currentUser && (currentUser.uid === p.uid || myData.isAdmin);
                    const delBtn = isOwner ? `<i class="ph ph-trash" onclick="deletePost('${p.id}')" style="color:#ff4d4f;cursor:pointer;"></i>` : '';
                    const editBtn = isOwner ? `<i class="ph ph-pencil-simple" onclick="openEditModal('${p.id}')" style="color:#6C5DD3;cursor:pointer;margin-right:10px;"></i>` : '';
                    
                    let timeDisplay = "Just now";
                    if(p.timestamp) {
                        const date = p.timestamp.toDate();
                        timeDisplay = date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    }
                    const displayText = makeLinksClickable(p.text || '');
                    const plainText = (p.text || '').replace(/"/g, '&quot;');
                    
                    const liveName = (userCache[p.uid]?.name) || p.authorName;
                    const livePhoto = (userCache[p.uid]?.photo) || p.authorPhoto;

                    container.innerHTML += `
                        <div class="post-card">
                            <div class="pc-header">
                                <div class="pc-user" onclick="startChat('${p.uid}', '${liveName}')">
                                    <img src="${livePhoto}" class="avatar" style="width:40px; height:40px;">
                                    <div>
                                        <div class="pc-name">${liveName} ${adminIcon}</div>
                                        <div class="pc-time">${timeDisplay}</div>
                                    </div>
                                </div>
                                <div>${editBtn}${delBtn}</div>
                            </div>
                            <div class="pc-text" id="text-${p.id}">${displayText}</div>
                            ${p.image ? `<img src="${p.image}" class="pc-img">` : ''}
                            
                            <div class="pc-stats">
                                <span>${p.likes ? p.likes.length : 0} Likes</span>
                                <span onclick="openOverlay('comment', '${p.id}')">${p.commentCount || 0} Comments</span>
                            </div>
                            <div class="pc-actions">
                                <div class="pc-btn ${isLiked?'liked':''}" onclick="toggleLike('${p.id}', ${isLiked})">
                                    <i class="${likeIcon}" style="font-size:20px;"></i> Like
                                </div>
                                <div class="pc-btn" onclick="openOverlay('comment', '${p.id}')">
                                    <i class="ph ph-chat-circle" style="font-size:20px;"></i> Comment
                                </div>
                                <div class="pc-btn" onclick="sharePost('${plainText}')">
                                    <i class="ph ph-share-network" style="font-size:20px;"></i> Share
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
    };

    const deletePost = (id) => confirm("Delete this post?") && db.collection('posts').doc(id).delete();
    
    window.deleteComment = (id) => {
        if(confirm("Are you sure you want to delete this comment?")) {
            db.collection('comments').doc(id).delete().then(() => {
                db.collection('posts').doc(activeTargetId).update({
                    commentCount: firebase.firestore.FieldValue.increment(-1)
                });
                showToast("Comment deleted");
            }).catch(e => showToast("Error deleting comment"));
        }
    };
    
    const toggleLike = (id, loved) => {
        if(!currentUser) return showToast("Please Login to Like!");
        db.collection('posts').doc(id).update({
            likes: loved ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
    };

    // --- FRIENDS LIST ---
    const loadFriends = () => {
        if(!currentUser) return;
        document.getElementById('friendList').innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-gray);'>Loading...</div>";
        db.collection('users').onSnapshot(snap => {
            const list = document.getElementById('friendList');
            list.innerHTML = "";
            let foundOthers = false;
            
            snap.forEach(d => { userCache[d.id] = d.data(); });

            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== currentUser.uid) {
                    foundOthers = true;
                    const isBanned = u.isBanned === true;
                    let banBtn = '';
                    if (myData.isAdmin) {
                        banBtn = `
                            <button onclick="toggleBanUser('${u.uid}', ${isBanned}, '${u.name}')" 
                                class="btn" style="background:${isBanned ? '#4caf50' : '#ff4d4f'}; color:white; padding:5px 10px; font-size:12px; margin-left:10px;">
                                ${isBanned ? 'Unban' : 'Ban'}
                            </button>
                        `;
                    }
                    
                    const showDot = unreadSenders.has(u.uid) ? 'block' : 'none';
                    
                    list.innerHTML += `
                        <div class="friend-card">
                            <img src="${u.photo}" class="avatar" style="width:50px; height:50px;" onclick="startChat('${u.uid}', '${u.name}')">
                            <div style="flex:1; margin-left:10px;">
                                <div style="font-weight:600;">${u.name} ${isBanned ? '<span style="color:red; font-size:10px;">(BANNED)</span>' : ''}</div>
                                <div style="font-size:12px; color:var(--text-gray);">Tap to chat</div>
                            </div>
                            <div id="noti-${u.uid}" class="friend-noti-dot" 
                                 style="width:10px; height:10px; background:#FF4D4F; border-radius:50%; display:${showDot}; margin-right:10px;">
                            </div>
                            ${banBtn}
                            <i class="ph-fill ph-chat-circle-dots" style="color:var(--primary); font-size:24px; cursor:pointer;" onclick="startChat('${u.uid}', '${u.name}')"></i>
                        </div>
                    `;
                }
            });
            if(!foundOthers) {
                list.innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-gray);">
                    <i class="ph ph-users" style="font-size:40px; opacity:0.5; margin-bottom:10px;"></i><br>
                    No other users found yet.<br>Invite friends to join!
                </div>`;
            }
        });
    };

    // --- OVERLAY (CHAT & COMMENTS) ---
    window.openOverlay = (mode, targetId, name = '') => {
        if(!currentUser) return showToast("Please Login First!");
        
        console.log(`ðŸ”“ Opening overlay: mode=${mode}, targetId=${targetId}, name=${name}`);
        
        overlayMode = mode;
        const screen = document.getElementById('overlayScreen');
        const title = document.getElementById('overlayTitle');
        const body = document.getElementById('overlayBody');
        
        screen.style.display = 'flex';
        
        if (mode === 'chat') {
            chatReceiverId = targetId;
            activeTargetId = [currentUser.uid, targetId].sort().join("_");
            title.innerText = name || "Chat";
            markMessagesAsRead(targetId);
        } else {
            chatReceiverId = null;
            activeTargetId = targetId; 
            title.innerText = "Comments";
        }
        
        body.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
        if(unsubOverlay) unsubOverlay();

        const ref = mode === 'comment' 
            ? db.collection('comments').where('postId', '==', activeTargetId) 
            : db.collection('messages').where('chatId', '==', activeTargetId);

        unsubOverlay = ref.onSnapshot(snap => {
            let list = [];
            snap.forEach(d => {
                const data = d.data();
                data.id = d.id;
                list.push(data);
            });
            
            list.sort((a,b) => {
                const tA = a.timestamp ? a.timestamp.toMillis() : Date.now();
                const tB = b.timestamp ? b.timestamp.toMillis() : Date.now();
                return tA - tB;
            });
            
            if(list.length === 0) {
                body.innerHTML = '<div style="text-align:center; color:var(--text-gray); margin-top:50px;">No messages yet.</div>';
            } else {
                body.innerHTML = list.map(item => {
                    const txt = makeLinksClickable(item.text || '');
                    
                    const displayName = (userCache[item.uid]?.name) || item.userName;
                    const displayPhoto = (userCache[item.uid]?.photo) || item.userPhoto;

                    if (mode === 'comment') {
                        const isMyComment = currentUser.uid === item.uid || myData.isAdmin;
                        const deleteBtn = isMyComment 
                            ? `<i class="ph ph-trash" style="color:#ff4d4f; cursor:pointer; font-size:14px;" onclick="deleteComment('${item.id}')"></i>` 
                            : '';

                        return `
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <img src="${displayPhoto}" class="avatar" style="width:32px; height:32px; margin-top:5px;">
                            <div class="bubble bubble-other">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                                    <span class="bubble-name">${displayName}</span>
                                    ${deleteBtn}
                                </div>
                                <span class="bubble-content">${txt}</span>
                            </div>
                        </div>`;
                    } else {
                        const isMe = item.sender === currentUser.uid;
                        return `
                        <div style="display:flex; flex-direction:column; margin-bottom:5px; align-items:${isMe?'flex-end':'flex-start'}">
                            <div class="bubble ${isMe ? 'bubble-me' : 'bubble-other'}">
                                <span class="bubble-content">${txt}</span>
                            </div>
                        </div>`;
                    }
                }).join('');
            }
            body.scrollTop = body.scrollHeight;
        }, error => {
            console.error("Overlay listener error:", error);
            body.innerHTML = '<div style="text-align:center; color:red; margin-top:50px;">Error loading messages.</div>';
        });
    };

    window.closeOverlay = () => {
        document.getElementById('overlayScreen').style.display = 'none';
        if(unsubOverlay) unsubOverlay();
        overlayMode = '';
        chatReceiverId = null;
    };

    window.handleOverlaySend = async () => {
        const txt = document.getElementById('overlayInput').value.trim();
        if(!txt) return;
        
        try {
            if(overlayMode === 'comment') {
                const batch = db.batch();
                batch.set(db.collection('comments').doc(), {
                    postId: activeTargetId, 
                    text: txt, 
                    uid: currentUser.uid,
                    userName: myData.name, 
                    userPhoto: myData.photo,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                batch.update(db.collection('posts').doc(activeTargetId), {
                    commentCount: firebase.firestore.FieldValue.increment(1)
                });
                await batch.commit();
            } else {
                await db.collection('messages').add({
                    chatId: activeTargetId,
                    text: txt, 
                    sender: currentUser.uid,
                    receiverId: chatReceiverId,
                    isRead: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            document.getElementById('overlayInput').value = "";
        } catch(e) {
            alert("Failed to send. You might be banned.");
        }
    };
    
    window.startChat = (uid, name) => {
        chatReceiverId = uid;
        openOverlay('chat', uid, name);
    };

    window.sharePost = (text) => {
        if (navigator.share) {
            navigator.share({ title: 'Social69 Post', text: text, url: window.location.href });
        } else {
            navigator.clipboard.writeText(text);
            showToast("Copied to clipboard!");
        }
    };

    // --- EDIT POST UTILS ---
    window.openEditModal = (id) => {
        editingPostId = id;
        const currentTextEl = document.getElementById(`text-${id}`);
        const currentText = currentTextEl ? currentTextEl.innerText : "";
        document.getElementById('editModalInput').value = currentText;
        document.getElementById('editModal').style.display = 'flex';
    };
    
    window.closeEditModal = () => { 
        document.getElementById('editModal').style.display = 'none'; 
        editingPostId = null; 
    };
    
    window.saveEditPost = () => {
        const newText = document.getElementById('editModalInput').value;
        if(editingPostId && newText) {
            db.collection('posts').doc(editingPostId).update({ text: newText })
            .then(() => { closeEditModal(); showToast("Post updated!"); });
        }
    };
    
    // ðŸ”¥ PROFILE EDIT MODAL LOGIC
    window.openProfileModal = () => {
        if(!currentUser) return showToast("Login first!");
        document.getElementById('modalProfileThumb').src = myData.photo || 'https://via.placeholder.com/100';
        document.getElementById('modalEditName').value = myData.name;
        document.getElementById('modalEditBio').value = myData.bio || "";
        document.getElementById('modalEditWebsite').value = myData.website || "";
        document.getElementById('profileEditModal').style.display = 'flex';
    };

    window.closeProfileModal = () => {
        document.getElementById('profileEditModal').style.display = 'none';
        document.getElementById('modalNewProfilePic').value = ''; 
    };

    window.previewProfileModalPic = () => {
        const file = document.getElementById('modalNewProfilePic').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('modalProfileThumb').src = e.target.result; }
            r.readAsDataURL(file);
        }
    };

    window.saveProfileChanges = () => {
        const newName = document.getElementById('modalEditName').value.trim();
        const newBio = document.getElementById('modalEditBio').value.trim();
        const newWebsite = document.getElementById('modalEditWebsite').value.trim();
        const newPhotoSrc = document.getElementById('modalProfileThumb').src;
        
        if(!newName) return showToast("Name cannot be empty");

        const updateData = { name: newName, bio: newBio, website: newWebsite };
        
        if(newPhotoSrc.startsWith('data:image')) {
            updateData.photo = newPhotoSrc;
        }

        db.collection('users').doc(currentUser.uid).update(updateData).then(() => {
            showToast("Profile Updated!");
            
            myData.name = newName;
            myData.bio = newBio;
            myData.website = newWebsite;
            if(updateData.photo) myData.photo = updateData.photo;
            
            userCache[currentUser.uid] = { ...userCache[currentUser.uid], ...updateData };

            updateUI();
            closeProfileModal();
        }).catch(err => {
            console.error(err);
            showToast("Error updating profile");
        });
    };
</script>
</body>
</html>
