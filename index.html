<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Social</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- Modern Theme Variables --- */
        :root {
            --primary: #6C5DD3;
            --primary-light: #A094E3;
            --accent: #FF754C;
            --bg-body: #F0F2F5;
            --bg-card: #FFFFFF;
            --text-main: #11142D;
            --text-gray: #808191;
            --border-radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-body); 
            margin: 0; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden;
            color: var(--text-main);
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 50% { transform: scale(1.2); } }

        /* --- Pull to Refresh Spinner --- */
        #ptr-spinner {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 25px; height: 25px; border-radius: 50%;
            border: 2px solid #ddd; border-top-color: var(--primary);
            animation: spin 0.8s infinite linear;
            display: none; z-index: 900; background: white; padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        @keyframes spin { to { transform: translateX(-50%) rotate(360deg); } }

        /* --- Components --- */
        .btn { border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(108, 93, 211, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-ghost { background: transparent; color: var(--text-gray); }
        .avatar { border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- Login Screen --- */
        #loginScreen { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .logo-area { text-align: center; margin-bottom: 40px; }
        .logo-icon { font-size: 60px; color: var(--primary); margin-bottom: 10px; }
        .logo-text { font-size: 28px; font-weight: 800; color: var(--text-main); }
        .login-options { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; }
        .login-btn { padding: 12px; border-radius: 15px; font-size: 16px; border: 1px solid #eee; background: white; color: var(--text-main); display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* --- Main App --- */
        #appInterface { display: none; flex-direction: column; height: 100%; }
        
        .header { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; 
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header-title { font-size: 20px; font-weight: 800; color: var(--primary); }

        .content-wrapper { flex: 1; overflow-y: auto; padding-bottom: 90px; position: relative; scroll-behavior: smooth; }
        .tab-page { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .active-tab { display: block; }

        /* --- Post Create --- */
        .create-box { background: var(--bg-card); border-radius: var(--border-radius); padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .input-row { display: flex; gap: 12px; align-items: center; margin-bottom: 15px; }
        .post-input { flex: 1; background: #F8F9FB; border: none; padding: 12px 15px; border-radius: 12px; font-size: 15px; color: var(--text-main); transition: 0.2s; }
        .post-input:focus { background: #fff; box-shadow: inset 0 0 0 2px var(--primary-light); }
        .action-row { display: flex; justify-content: space-between; align-items: center; }
        .photo-trigger { color: var(--primary); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 5px 10px; border-radius: 8px; background: rgba(108, 93, 211, 0.1); }

        /* --- Feed Post --- */
        .post-card { background: var(--bg-card); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 20px rgba(0,0,0,0.02); }
        .pc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .pc-user { display: flex; gap: 10px; align-items: center; }
        .pc-name { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 4px; }
        .admin-badge { color: var(--primary); font-size: 14px; }
        .pc-time { font-size: 11px; color: var(--text-gray); margin-top: 2px; }
        .pc-text { font-size: 15px; line-height: 1.5; margin-bottom: 10px; color: #444; word-wrap: break-word; }
        .pc-text a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .pc-text a:hover { text-decoration: underline; }
        .pc-img { width: 100%; border-radius: 12px; margin-top: 10px; max-height: 400px; object-fit: cover; }
        
        .pc-stats { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-gray); margin: 15px 0 10px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .pc-actions { display: flex; justify-content: space-between; }
        .pc-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-gray); font-weight: 600; padding: 8px; border-radius: 8px; cursor: pointer; }
        .pc-btn:active { background: #f5f5f5; }
        .pc-btn.liked { color: var(--accent); }
        .pc-btn.liked i { animation: pop 0.3s ease; }

        /* --- Floating Navigation --- */
        .nav-dock { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; width: 90%; max-width: 400px; height: 65px;
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 2000; padding: 0 10px;
        }
        .nav-item { font-size: 24px; color: #D1D1D1; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); background: rgba(108, 93, 211, 0.1); transform: translateY(-5px); }
        .nav-indicator { width: 4px; height: 4px; background: var(--primary); border-radius: 50%; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); display: none; }
        .nav-item.active .nav-indicator { display: block; }

        /* --- Comments & Chat Overlay --- */
        .overlay-screen { position: fixed; inset: 0; background: white; z-index: 3000; display: none; flex-direction: column; animation: fadeIn 0.2s; }
        .os-header { height: 60px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #f0f0f0; gap: 15px; }
        .os-title { font-weight: 700; font-size: 18px; }
        .os-body { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-body); display: flex; flex-direction: column; gap: 10px; }
        .os-input { padding: 15px; background: white; border-top: 1px solid #f0f0f0; display: flex; gap: 10px; }
        
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 15px; position: relative; word-wrap: break-word; }
        .bubble-me { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble-other { background: white; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* --- Friend List Item --- */
        .friend-card { background: white; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        
        /* --- Profile --- */
        .profile-header { background: white; border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
    </style>
</head>
<body>

    <div id="ptr-spinner"></div>

    <div id="loginScreen">
        <div class="logo-area">
            <i class="ph ph-hexagon logo-icon"></i>
            <div class="logo-text">Social Hub</div>
            <p style="color:var(--text-gray);">Connect simply.</p>
        </div>
        <div class="login-options">
            <button class="login-btn" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Continue with Google
            </button>
            <button class="login-btn" onclick="loginGithub()">
                <i class="ph-fill ph-github-logo" style="font-size:22px;"></i>
                Continue with GitHub
            </button>
        </div>
    </div>

    <div id="appInterface">
        <div class="header">
            <div class="header-title">Social Hub</div>
            <img id="myHeaderThumb" class="avatar" style="width:35px; height:35px;" onclick="switchTab('profile')">
        </div>

        <div class="content-wrapper" id="contentArea">
            
            <div id="tab-home" class="tab-page active-tab">
                <div class="create-box">
                    <div class="input-row">
                        <img id="postThumb" class="avatar" style="width:40px; height:40px;">
                        <input type="text" id="postInput" class="post-input" placeholder="What's happening?">
                    </div>
                    <img id="previewImg" style="width:100%; border-radius:12px; display:none; margin-bottom:15px;">
                    <div class="action-row">
                        <label for="postFile" class="photo-trigger">
                            <i class="ph ph-image"></i> Photo
                        </label>
                        <input type="file" id="postFile" accept="image/*" style="display:none" onchange="previewFile()">
                        <button class="btn btn-primary" onclick="submitPost()">Post</button>
                    </div>
                </div>

                <div id="feedContainer"></div>
                <div style="text-align:center; padding:20px; color:#ccc; font-size:12px;">End of Feed</div>
            </div>

            <div id="tab-friends" class="tab-page">
                <h3 style="margin:0 0 15px 0;">People</h3>
                <div id="friendList"></div>
            </div>

            <div id="tab-profile" class="tab-page">
                <div class="profile-header">
                    <div style="position:relative; display:inline-block;">
                        <img id="profilePic" class="avatar" style="width:100px; height:100px; border:4px solid var(--bg-body);">
                        <label for="newProfilePic" style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <i class="ph ph-camera"></i>
                        </label>
                        <input type="file" id="newProfilePic" accept="image/*" style="display:none" onchange="uploadProfilePic()">
                    </div>
                    <h2 id="profileNameDisplay" style="margin:15px 0 5px;">User Name</h2>
                    <input type="text" id="editName" class="post-input" style="text-align:center; margin-bottom:15px;" placeholder="Edit display name">
                    <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="saveName()">Save Changes</button>
                    <button class="btn btn-ghost" style="width:100%; color:#ff4d4f;" onclick="auth.signOut()">
                        <i class="ph ph-sign-out"></i> Log Out
                    </button>
                </div>
            </div>

        </div>

        <div class="nav-dock">
            <div class="nav-item active" onclick="switchTab('home', this)">
                <i class="ph-fill ph-house"></i>
                <div class="nav-indicator"></div>
            </div>
            <div class="nav-item" onclick="switchTab('friends', this)">
                <i class="ph-fill ph-users"></i>
                <div class="nav-indicator"></div>
            </div>
            <div class="nav-item" onclick="switchTab('profile', this)">
                <i class="ph-fill ph-user"></i>
                <div class="nav-indicator"></div>
            </div>
        </div>
    </div>

    <div id="overlayScreen" class="overlay-screen">
        <div class="os-header">
            <i class="ph ph-arrow-left" style="font-size:24px; cursor:pointer;" onclick="closeOverlay()"></i>
            <div class="os-title" id="overlayTitle">Comments</div>
        </div>
        <div id="overlayBody" class="os-body"></div>
        <div class="os-input">
            <input type="text" id="overlayInput" class="post-input" placeholder="Type here...">
            <button class="btn btn-primary" style="padding:10px;" onclick="handleOverlaySend()">
                <i class="ph-fill ph-paper-plane-right"></i>
            </button>
        </div>
    </div>

<script>
    // âš ï¸ CONFIGURATION (Replace with yours)
    const firebaseConfig = {
      apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
      authDomain: "chat-27f21.firebaseapp.com",
      projectId: "chat-27f21",
      storageBucket: "chat-27f21.firebasestorage.app",
      messagingSenderId: "582814616396",
      appId: "1:582814616396:web:251660e2a50635bc70dde9"
    };
    const ADMIN_EMAIL = "mmtintaungkhaing@gmail.com"; 

    // --- SETUP ---
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let myData = {};
    let overlayMode = ''; 
    let activeTargetId = null; 
    let unsubOverlay = null;
    let feedUnsubscribe = null;

    // --- HELPER: Make Links Clickable ---
    const makeLinksClickable = (text) => {
        if (!text) return '';
        // Regex to find URLs (starts with http:// or https://)
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            return `<a href="${url}" target="_blank">${url}</a>`;
        });
    };

    // --- PULL TO REFRESH LOGIC ---
    let pStart = {x:0, y:0};
    const contentArea = document.getElementById('contentArea');
    const ptrSpinner = document.getElementById('ptr-spinner');

    contentArea.addEventListener('touchstart', e => { pStart.y = e.touches[0].clientY; });
    contentArea.addEventListener('touchmove', e => {
        let y = e.touches[0].clientY;
        if(contentArea.scrollTop === 0 && y > pStart.y + 70) {
            ptrSpinner.style.display = 'block';
        }
    });
    contentArea.addEventListener('touchend', e => {
        if(ptrSpinner.style.display === 'block') {
            loadFeed(); 
            setTimeout(() => { ptrSpinner.style.display = 'none'; }, 800);
        }
    });

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appInterface').style.display = 'flex';
            
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    myData = doc.data();
                } else {
                    myData = { 
                        name: user.displayName, photo: user.photoURL, 
                        uid: user.uid, email: user.email, 
                        isAdmin: (user.email === ADMIN_EMAIL) 
                    };
                    doc.ref.set(myData);
                }
                updateUI();
                loadFriends();
            });
            loadFeed();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appInterface').style.display = 'none';
        }
    });

    const loginGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    const loginGithub = () => auth.signInWithPopup(new firebase.auth.GithubAuthProvider()).catch(e => alert("Please enable GitHub in Firebase Console!"));
    
    const updateUI = () => {
        const pic = myData.photo || 'https://via.placeholder.com/100';
        ['myHeaderThumb', 'postThumb', 'profilePic'].forEach(id => document.getElementById(id).src = pic);
        document.getElementById('editName').value = myData.name;
        document.getElementById('profileNameDisplay').innerText = myData.name;
    };

    // --- NAVIGATION ---
    window.switchTab = (tab, el) => {
        document.querySelectorAll('.tab-page').forEach(t => t.classList.remove('active-tab'));
        document.getElementById('tab-'+tab).classList.add('active-tab');
        
        if(el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
    };

    // --- POSTS ---
    const previewFile = () => {
        const file = document.getElementById('postFile').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => { document.getElementById('previewImg').src = e.target.result; document.getElementById('previewImg').style.display = 'block'; }
            r.readAsDataURL(file);
        }
    };

    const submitPost = async () => {
        const text = document.getElementById('postInput').value;
        const img = document.getElementById('previewImg').style.display === 'block' ? document.getElementById('previewImg').src : null;
        if(!text && !img) return;

        await db.collection('posts').add({
            text, image: img, uid: currentUser.uid,
            authorName: myData.name, authorPhoto: myData.photo,
            isAdmin: myData.isAdmin || false, likes: [],
            commentCount: 0,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        document.getElementById('postInput').value = "";
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('previewImg').src = "";
    };

    const loadFeed = () => {
        if(feedUnsubscribe) feedUnsubscribe(); 

        // Removed .limit(50) to show ALL existing data as requested
        feedUnsubscribe = db.collection('posts')
            .orderBy('timestamp', 'desc')
            .onSnapshot(snap => {
                const container = document.getElementById('feedContainer');
                container.innerHTML = "";
                
                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    const isLiked = p.likes && p.likes.includes(currentUser.uid);
                    const likeIcon = isLiked ? 'ph-fill ph-heart' : 'ph ph-heart';
                    const adminIcon = p.isAdmin ? `<i class="ph-fill ph-seal-check admin-badge"></i>` : '';
                    const delBtn = (currentUser.uid === p.uid || myData.isAdmin) ? `<i class="ph ph-trash" onclick="deletePost('${p.id}')" style="color:#ff4d4f;cursor:pointer;"></i>` : '';
                    
                    let timeDisplay = "Just now";
                    if(p.timestamp) {
                        const date = p.timestamp.toDate();
                        timeDisplay = date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    }

                    const commentCount = p.commentCount ? p.commentCount : 0;
                    
                    // Apply link clickable function here
                    const displayText = makeLinksClickable(p.text || '');

                    container.innerHTML += `
                        <div class="post-card">
                            <div class="pc-header">
                                <div class="pc-user" onclick="startChat('${p.uid}', '${p.authorName}')">
                                    <img src="${p.authorPhoto}" class="avatar" style="width:40px; height:40px;">
                                    <div>
                                        <div class="pc-name">${p.authorName} ${adminIcon}</div>
                                        <div class="pc-time">${timeDisplay}</div>
                                    </div>
                                </div>
                                ${delBtn}
                            </div>
                            <div class="pc-text">${displayText}</div>
                            ${p.image ? `<img src="${p.image}" class="pc-img">` : ''}
                            
                            <div class="pc-stats">
                                <span>${p.likes ? p.likes.length : 0} Likes</span>
                                <span onclick="openOverlay('comment', '${p.id}')">${commentCount} Comments</span>
                            </div>
                            <div class="pc-actions">
                                <div class="pc-btn ${isLiked?'liked':''}" onclick="toggleLike('${p.id}', ${isLiked})">
                                    <i class="${likeIcon}" style="font-size:20px;"></i> Like
                                </div>
                                <div class="pc-btn" onclick="openOverlay('comment', '${p.id}')">
                                    <i class="ph ph-chat-circle" style="font-size:20px;"></i> Comment
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
    };

    const deletePost = (id) => confirm("Delete this post?") && db.collection('posts').doc(id).delete();
    const toggleLike = (id, loved) => db.collection('posts').doc(id).update({
        likes: loved ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });

    // --- OVERLAY (CHAT & COMMENTS) ---
    window.openOverlay = (mode, targetId, name = '') => {
        overlayMode = mode;
        activeTargetId = targetId;
        const screen = document.getElementById('overlayScreen');
        const title = document.getElementById('overlayTitle');
        const body = document.getElementById('overlayBody');
        
        screen.style.display = 'flex';
        body.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
        if(unsubOverlay) unsubOverlay();

        if (mode === 'comment') {
            title.innerText = "Comments";
            unsubOverlay = db.collection('comments').where('postId', '==', targetId).onSnapshot(snap => {
                body.innerHTML = '';
                let list = [];
                snap.forEach(d => list.push(d.data()));
                list.sort((a,b) => (a.timestamp?.toMillis()||0) - (b.timestamp?.toMillis()||0));
                
                if(list.length === 0) body.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">No comments yet.</div>';

                body.innerHTML += list.map(c => `
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <img src="${c.userPhoto}" class="avatar" style="width:32px; height:32px;">
                        <div class="bubble bubble-other">
                            <div style="font-weight:bold; font-size:12px; opacity:0.7; margin-bottom:2px;">${c.userName}</div>
                            ${makeLinksClickable(c.text)}
                        </div>
                    </div>
                `).join('');
                body.scrollTop = body.scrollHeight;
            });
        } else {
            // CHAT - FIX FOR LOADING STUCK
            title.innerText = name;
            const ids = [currentUser.uid, targetId].sort();
            const chatId = ids.join("_");
            activeTargetId = chatId; 

            // REMOVED .orderBy HERE to prevent Index Error
            unsubOverlay = db.collection('messages')
                .where('chatId', '==', chatId)
                .onSnapshot(snap => {
                    let msgs = [];
                    snap.forEach(d => msgs.push(d.data()));
                    
                    // CLIENT-SIDE SORTING
                    msgs.sort((a,b) => (a.timestamp?.toMillis()||0) - (b.timestamp?.toMillis()||0));

                    if(msgs.length === 0) {
                        body.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">Say Hi! ðŸ‘‹</div>';
                    } else {
                        body.innerHTML = msgs.map(m => {
                            const isMe = m.sender === currentUser.uid;
                            return `<div class="bubble ${isMe ? 'bubble-me' : 'bubble-other'}" style="margin-bottom:5px;">${makeLinksClickable(m.text)}</div>`;
                        }).join('');
                    }
                    body.scrollTop = body.scrollHeight;
                });
        }
    };

    window.closeOverlay = () => {
        document.getElementById('overlayScreen').style.display = 'none';
        if(unsubOverlay) unsubOverlay();
    };

    window.handleOverlaySend = () => {
        const txt = document.getElementById('overlayInput').value;
        if(!txt) return;

        if(overlayMode === 'comment') {
            const batch = db.batch();
            const commentRef = db.collection('comments').doc();
            const postRef = db.collection('posts').doc(activeTargetId);

            batch.set(commentRef, {
                postId: activeTargetId, text: txt, uid: currentUser.uid,
                userName: myData.name, userPhoto: myData.photo,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            batch.update(postRef, {
                commentCount: firebase.firestore.FieldValue.increment(1)
            });

            batch.commit();

        } else {
            db.collection('messages').add({
                chatId: activeTargetId, text: txt, sender: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        document.getElementById('overlayInput').value = "";
    };

    // --- FRIENDS & PROFILE ---
    const loadFriends = () => {
        db.collection('users').onSnapshot(snap => {
            const list = document.getElementById('friendList');
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== currentUser.uid) {
                    list.innerHTML += `
                        <div class="friend-card" onclick="startChat('${u.uid}', '${u.name}')">
                            <img src="${u.photo}" class="avatar" style="width:50px; height:50px;">
                            <div style="flex:1; font-weight:600;">${u.name}</div>
                            <i class="ph-fill ph-chat-circle-dots" style="color:var(--primary); font-size:24px;"></i>
                        </div>
                    `;
                }
            });
        });
    };
    
    window.startChat = (uid, name) => openOverlay('chat', uid, name);

    window.saveName = () => {
        db.collection('users').doc(currentUser.uid).update({ name: document.getElementById('editName').value })
        .then(() => alert("Saved!"));
    };

    window.uploadProfilePic = () => {
        const file = document.getElementById('newProfilePic').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = e => db.collection('users').doc(currentUser.uid).update({ photo: e.target.result });
            r.readAsDataURL(file);
        }
    };

</script>
</body>
</html>
