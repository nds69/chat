<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; height: 100vh; }
        .chat-container { width: 100%; max-width: 500px; background: white; display: flex; flex-direction: column; height: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { background: #0084ff; color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        /* Chat Box */
        .messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-color: #e5ddd5;}
        
        .message { padding: 10px; border-radius: 10px; max-width: 75%; word-wrap: break-word; font-size: 15px; position: relative; }
        .my-msg { background-color: #dcf8c6; align-self: flex-end; } /* ·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äï·Ä≠·ÄØ·Ä∑·Äê·Ä≤·Ä∑·ÄÖ·Ä¨ */
        .other-msg { background-color: white; align-self: flex-start; } /* ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äê·Ä≤·Ä∑·ÄÖ·Ä¨ */
        
        .message img { max-width: 100%; border-radius: 5px; display: block; margin-bottom: 5px; }
        .timestamp { font-size: 10px; color: #555; text-align: right; margin-top: 5px; }

        /* Input Area */
        .input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; align-items: center; background: white; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        button { background: #0084ff; color: white; border: none; padding: 10px 15px; margin-left: 8px; border-radius: 50%; cursor: pointer; font-weight: bold;}
        .file-btn { font-size: 24px; margin-right: 10px; cursor: pointer; color: #555; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">Chat Room</div>
    
    <div class="messages" id="messageList">
        </div>

    <div class="input-area">
        <label for="fileInput" class="file-btn">üì∑</label>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <input type="text" id="msgInput" placeholder="·ÄÖ·Ä¨·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´...">
        <button onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    // --------------------------------------------------------------
    // ·ÅÅ·Åã ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ Firebase ·ÄÄ·Äï·Ä±·Ä∏·Äê·Ä≤·Ä∑ ·ÄÄ·ÄØ·Äí·Ä∫·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·Äï·Ä´
    // --------------------------------------------------------------
  const firebaseConfig = {
  apiKey: "AIzaSyCUteIjOOPxPYrCutDSo9t0cVtLqnGTWxU",
  authDomain: "chat-27f21.firebaseapp.com",
  projectId: "chat-27f21",
  storageBucket: "chat-27f21.firebasestorage.app",
  messagingSenderId: "582814616396",
  appId: "1:582814616396:web:251660e2a50635bc70dde9"
};
    // --------------------------------------------------------------

    // Firebase ·ÄÖ·Äê·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫·ÄÖ·ÄÄ·Ä∫·Ä°·Äô·Äæ·Äê·Ä∫·Ä°·Äû·Ä¨·Ä∏ (·Äô·Äê·Ä∞·Ää·ÄÆ·Äê·Ä≤·Ä∑ user ·ÄÅ·ÄΩ·Ä≤·Äñ·Ä≠·ÄØ·Ä∑·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äö·Ä¨·Äö·ÄÆ·Äû·ÄØ·Ä∂·Ä∏·Äï·Ä´·Äô·Äö·Ä∫)
    const myID = localStorage.getItem('userID') || 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('userID', myID);

    // ·ÅÇ·Åã ·ÄÖ·Ä¨·Äú·ÄÄ·Ä∫·ÄÅ·Ä∂·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Real-time Listening)
    db.collection("chats").orderBy("timestamp", "asc").onSnapshot((snapshot) => {
        const list = document.getElementById("messageList");
        list.innerHTML = ""; // ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äë·ÄØ·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Ä°·Äû·ÄÖ·Ä∫·Äï·Äº·Äî·Ä∫·ÄÖ·ÄÆ

        snapshot.forEach((doc) => {
            const data = doc.data();
            const msgDiv = document.createElement("div");
            
            // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äï·Ä≠·ÄØ·Ä∑·Äê·Ä¨·Äú·Ä¨·Ä∏ ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äê·Ä¨·Äú·Ä¨·Ä∏ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
            const msgClass = (data.sender === myID) ? "my-msg" : "other-msg";
            msgDiv.className = `message ${msgClass}`;

            let content = "";
            if (data.image) {
                content += `<img src="${data.image}">`;
            }
            if (data.text) {
                content += `<div>${data.text}</div>`;
            }
            
            msgDiv.innerHTML = content;
            list.appendChild(msgDiv);
        });

        // ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·ÄÜ·ÄΩ·Ä≤·ÄÅ·Äª
        list.scrollTop = list.scrollHeight;
    });

    // ·ÅÉ·Åã ·ÄÖ·Ä¨·Äï·Ä≠·ÄØ·Ä∑·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ Function
    function sendMsg() {
        const input = document.getElementById("msgInput");
        const fileInput = document.getElementById("fileInput");
        const text = input.value;
        const file = fileInput.files[0];

        if (!text && !file) return;

        // ·Äï·ÄØ·Ä∂·Äï·Ä´·Äú·Ä¨·Äõ·ÄÑ·Ä∫ Base64 ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·Äï·Ä≠·ÄØ·Ä∑·Äô·Äö·Ä∫
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Img = e.target.result;
                saveToDB(text, base64Img);
            }
            reader.readAsDataURL(file);
        } else {
            saveToDB(text, null);
        }

        // ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
        input.value = "";
        fileInput.value = "";
    }

    // Database ·Äë·Ä≤ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
    function saveToDB(text, img) {
        db.collection("chats").add({
            text: text,
            image: img,
            sender: myID,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // Enter ·ÄÅ·Ä±·Ä´·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫ ·Äï·Ä≠·ÄØ·Ä∑·Äô·Äö·Ä∫
    document.getElementById("msgInput").addEventListener("keypress", (e) => {
        if(e.key === "Enter") sendMsg();
    });
</script>

</body>
</html>
